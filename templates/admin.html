<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel Administrador</title>

  <style>
    :root{
      --blue:#003f8f;
      --blue-2:#0a56b5;
      --bg:#f4f6f9;
      --card:#ffffff;
      --border:#d7dbe2;
      --text:#1f2937;
      --muted:#6b7280;
      --danger:#b00020;
      --success:#0f9d58;
      --shadow: 0 10px 22px rgba(0,0,0,.08);
      --radius: 12px;
    }

    *{ box-sizing:border-box; font-family: Arial, Helvetica, sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--text); overflow-x: hidden; }
    html { overflow-x: hidden; }

    .topbar{
      background:var(--blue);
      padding:14px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      color:#fff;
      position:sticky;
      top:0;
      z-index:10;
      box-shadow:0 6px 16px rgba(0,0,0,.12);
    }
    .topbar-left{ display:flex; align-items:center; gap:14px; }
    .topbar img{ height:44px; }
    .topbar-info{ font-size:12px; line-height:1.3; }

    .btn{
      height:34px;
      padding:0 12px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-size:11px;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#e5e7eb;
      transition: all 0.2s;
    }
    .btn:hover:not(:disabled){ transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn-danger{ background:var(--danger); color:#fff; }

    .badge{
      padding:4px 8px;
      border-radius:8px;
      font-size:11px;
      font-weight:bold;
    }
    .badge-ok{ background:#e6f4ea; color:var(--success); }
    .badge-off{ background:#fdecea; color:var(--danger); }

    .container{
      max-width:1400px;
      margin:18px auto;
      padding:0 18px;
      overflow-x: hidden;
    }

    .panel{
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      margin-bottom:16px;
      overflow-x: hidden;
    }

    /* ‚úÖ SCROLL MEJORADO */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      overflow-y: auto;
      max-height: 600px;
      margin-top: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      /* Mantener scroll horizontal visible */
      scrollbar-width: thin;
      scrollbar-color: var(--blue-2) #e5e7eb;
    }

    /* Estilos personalizados de scrollbar para Webkit (Chrome, Safari) */
    .table-wrapper::-webkit-scrollbar {
      height: 10px;
      width: 10px;
    }

    .table-wrapper::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .table-wrapper::-webkit-scrollbar-thumb {
      background: var(--blue-2);
      border-radius: 10px;
    }

    .table-wrapper::-webkit-scrollbar-thumb:hover {
      background: var(--blue);
    }

    table{
      width:100%;
      min-width:1700px; /* ‚úÖ Aumentado por nueva columna */
      border-collapse:separate;
      border-spacing:0;
      font-size:12px;
    }
    
    /* Tablas de usuarios y logs m√°s estrechas */
    #usuarios table,
    #logs table {
      min-width: 100%;
    }
    thead th{
      background:#f8fafc;
      padding:10px;
      font-weight:800;
      border-bottom:1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tbody td{
      padding:10px;
      border-bottom:1px solid #eef2f7;
      white-space:nowrap;
    }

    .admin-layout{
      display:flex;
      gap:16px;
      position: relative;
    }
    
    /* Espacio para el sidebar fixed */
    .admin-layout::before {
      content: '';
      width: 220px;
      min-width: 220px;
      flex-shrink: 0;
    }
    .sidebar{
      width:220px;
      min-width:220px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      height:fit-content;
      position: fixed;
      top: 90px;
      left: 18px;
    }
    .side-btn{
      all:unset;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      font-weight:700;
      transition: all 0.2s;
    }
    .side-btn:hover{
      background:#f3f4f6;
    }
    .side-btn.active{
      background:#eaf2ff;
      color:var(--blue-2);
    }
    .content{ 
      flex:1; 
      min-width: 0;
    }

    /* SUB-PESTA√ëAS */
    .sub-tabs {
      display: flex;
      gap: 0;
      border-bottom: 2px solid var(--border);
      margin-bottom: 0;
    }

    .sub-tab-btn {
      all: unset;
      padding: 12px 24px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      color: var(--muted);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .sub-tab-btn:hover {
      background: #f9fafb;
      color: var(--text);
    }

    .sub-tab-btn.active {
      color: var(--blue);
      border-bottom-color: var(--blue);
      background: #f0f4ff;
    }

    .sub-badge {
      background: var(--blue-2);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
    }

    .sub-tab-btn.active .sub-badge {
      background: var(--blue);
    }

    .sub-tab-content {
      display: block;
    }

    .sub-tab-content[hidden] {
      display: none;
    }

    /* Animaci√≥n para nuevas filas */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .new-row {
      animation: slideIn 0.3s ease-out;
    }

    /* MODAL STYLES */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-overlay.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal {
      background: white;
      border-radius: 16px;
      padding: 0;
      max-width: 440px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    .modal-header {
      padding: 24px 24px 16px;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }

    .modal-body {
      padding: 24px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.6;
    }

    .modal-footer {
      padding: 16px 24px 24px;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 24px;
      border-radius: 10px;
      border: none;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .modal-btn-cancel {
      background: #f3f4f6;
      color: var(--text);
    }

    .modal-btn-confirm {
      background: var(--blue);
      color: white;
    }

    .modal-btn-danger {
      background: var(--danger);
      color: white;
    }

    .modal-btn-success {
      background: var(--success);
      color: white;
    }

    .modal-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 28px;
    }

    .modal-icon.success {
      background: #e6f4ea;
      color: var(--success);
    }

    .modal-icon.error {
      background: #fdecea;
      color: var(--danger);
    }

    .modal-icon.warning {
      background: #fff4e5;
      color: #f59e0b;
    }

    .modal-icon.info {
      background: #eaf2ff;
      color: var(--blue-2);
    }

    /* Bot√≥n eliminar X */
    .btn-delete {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      background: var(--danger);
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
    }
    
    .btn-delete:hover {
      background: #8b0017;
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(176, 0, 32, 0.3);
    }

    /* ‚úÖ Bot√≥n ojo para contrase√±a */
    .btn-eye {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: none;
      background: var(--blue-2);
      color: white;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-eye:hover {
      background: var(--blue);
      transform: scale(1.1);
    }

    /* Animaci√≥n para filas eliminadas */
    @keyframes slideOutLeft {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(-30px);
      }
    }

    .removing-row {
      animation: slideOutLeft 0.3s ease-out;
    }

    /* ‚úÖ NUEVAS ANIMACIONES */
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100px);
      }
    }

    /* ============================================ */
    /* üì± RESPONSIVE DESIGN - MEDIA QUERIES */
    /* ============================================ */

    /* TABLETS Y DISPOSITIVOS MEDIANOS (hasta 1024px) */
    @media (max-width: 1024px) {
      .container {
        padding: 0 12px;
        margin: 12px auto;
      }

      .admin-layout {
        flex-direction: column;
      }

      .admin-layout::before {
        display: none;
      }

      .sidebar {
        position: relative;
        width: 100%;
        top: 0;
        left: 0;
        flex-direction: row;
        overflow-x: auto;
        gap: 6px;
        padding: 8px;
      }

      .side-btn {
        white-space: nowrap;
        font-size: 12px;
        padding: 8px 12px;
      }

      .panel {
        padding: 12px;
      }

      .table-wrapper {
        max-height: 500px;
      }
    }

    /* M√ìVILES (hasta 768px) */
    @media (max-width: 768px) {
      .topbar {
        padding: 10px 12px;
        flex-wrap: wrap;
      }

      .topbar img {
        height: 36px;
      }

      .topbar-info {
        font-size: 10px;
      }

      .topbar-left {
        gap: 8px;
      }

      .btn {
        height: 30px;
        padding: 0 10px;
        font-size: 10px;
      }

      .container {
        margin: 8px auto;
        padding: 0 8px;
      }

      .sidebar {
        padding: 6px;
        gap: 4px;
      }

      .side-btn {
        font-size: 11px;
        padding: 6px 10px;
      }

      .panel h2 {
        font-size: 18px;
      }

      .panel h3 {
        font-size: 16px;
      }

      /* Estad√≠sticas responsive */
      #statsAreas,
      .panel > div > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }

      /* Sub-pesta√±as */
      .sub-tabs {
        overflow-x: auto;
        gap: 4px;
      }

      .sub-tab-btn {
        padding: 10px 16px;
        font-size: 11px;
        white-space: nowrap;
      }

      .sub-badge {
        font-size: 10px;
        padding: 2px 6px;
      }

      /* Tablas */
      .table-wrapper {
        max-height: 400px;
        margin-top: 12px;
      }

      table {
        font-size: 10px;
      }

      thead th {
        padding: 8px 6px;
        font-size: 10px;
      }

      tbody td {
        padding: 8px 6px;
      }

      /* Botones en tablas */
      .btn-delete,
      .btn-eye {
        width: 24px;
        height: 24px;
        font-size: 12px;
      }

      /* Formulario crear usuario */
      #formUsuario {
        flex-direction: column;
      }

      #formUsuario .btn,
      #formUsuario input,
      #formUsuario select {
        width: 100%;
      }

      /* Modal */
      .modal {
        width: 95%;
        max-width: 100%;
      }

      .modal-header {
        padding: 16px 16px 12px;
      }

      .modal-title {
        font-size: 16px;
      }

      .modal-body {
        padding: 16px;
        font-size: 13px;
      }

      .modal-footer {
        padding: 12px 16px 16px;
        flex-direction: column-reverse;
      }

      .modal-btn {
        width: 100%;
        padding: 12px;
      }

      .modal-icon {
        width: 48px;
        height: 48px;
        font-size: 24px;
      }
    }

    /* M√ìVILES PEQUE√ëOS (hasta 480px) */
    @media (max-width: 480px) {
      .topbar {
        padding: 8px 10px;
      }

      .topbar img {
        height: 32px;
      }

      .topbar-info {
        font-size: 9px;
      }

      .topbar-info div {
        display: none;
      }

      .topbar-info div:first-child {
        display: block;
      }

      .btn {
        height: 28px;
        padding: 0 8px;
        font-size: 9px;
        gap: 4px;
      }

      .panel {
        padding: 10px;
        border-radius: 8px;
      }

      .panel h2 {
        font-size: 16px;
        margin-bottom: 12px !important;
      }

      .panel h3 {
        font-size: 14px;
      }

      .sidebar {
        padding: 4px;
      }

      .side-btn {
        font-size: 10px;
        padding: 6px 8px;
      }

      .sub-tab-btn {
        padding: 8px 12px;
        font-size: 10px;
      }

      table {
        font-size: 9px;
        min-width: 1400px;
      }

      thead th {
        padding: 6px 4px;
      }

      tbody td {
        padding: 6px 4px;
      }

      .badge {
        font-size: 9px;
        padding: 3px 6px;
      }

      /* Botones m√°s peque√±os */
      .btn-delete,
      .btn-eye {
        width: 22px;
        height: 22px;
        font-size: 11px;
      }

      /* Estad√≠sticas cards */
      .panel > div > div > div {
        padding: 16px !important;
      }

      .modal-title {
        font-size: 14px;
      }

      .modal-body {
        font-size: 12px;
        padding: 12px;
      }
    }

    /* LANDSCAPE MODE (celulares en horizontal) */
    @media (max-height: 500px) and (orientation: landscape) {
      .topbar {
        position: relative;
      }

      .sidebar {
        position: relative;
        top: 0;
      }

      .table-wrapper {
        max-height: 300px;
      }
    }
  </style>
</head>

<body>

<div class="topbar">
  <div class="topbar-left">
    <img src="/static/img/mml.png">
    <div class="topbar-info">
      <div><strong>Administrador:</strong> {{ usuario }}</div>
      <div id="datetime"></div>
    </div>
  </div>
  <a href="/logout" class="btn btn-danger">üö™ Cerrar sesi√≥n</a>
</div>

<div class="container admin-layout">

  <aside class="sidebar">
    <button class="side-btn active" data-tab="stats">üìä Estad√≠sticas</button>
    <button class="side-btn" data-tab="postulantes">üìã Postulantes</button>
    <button class="side-btn" data-tab="usuarios">üë§ Usuarios</button>
    <button class="side-btn" data-tab="logs">üïí Logs</button>
  </aside>

  <main class="content">

    <section class="panel tab" id="stats">
      <h2 style="margin-bottom: 24px;">üìä Estad√≠sticas del Sistema</h2>
      
      <!-- ESTAD√çSTICAS POR G√âNERO -->
      <div style="margin-bottom: 32px;">
        <h3 style="margin-bottom: 16px; color: var(--muted);">üë• Postulantes por G√©nero</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 16px;">
          
          <!-- Card Mujeres -->
          <div style="background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%); border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(233, 30, 99, 0.15);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
              <div style="width: 56px; height: 56px; background: #ec407a; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white;">
                üë©
              </div>
              <div>
                <div style="font-size: 18px; font-weight: 700; color: #880e4f;">MUJERES</div>
                <div style="font-size: 12px; color: #ad1457;">Postulantes</div>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <!-- Registradas -->
              <div style="background: rgba(255,255,255,0.5); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 11px; font-weight: 700; color: #ad1457; margin-bottom: 8px;">REGISTRADAS</div>
                <div style="font-size: 32px; font-weight: 800; color: #c2185b;" id="statMujeresRegistradas">0</div>
              </div>
              
              <!-- Recibidas -->
              <div style="background: rgba(255,255,255,0.5); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 11px; font-weight: 700; color: #ad1457; margin-bottom: 8px;">RECIBIDAS</div>
                <div style="font-size: 32px; font-weight: 800; color: #c2185b;" id="statMujeresRecibidas">0</div>
              </div>
            </div>
          </div>
          
          <!-- Card Hombres -->
          <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
              <div style="width: 56px; height: 56px; background: #2196f3; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white;">
                üë®
              </div>
              <div>
                <div style="font-size: 18px; font-weight: 700; color: #0d47a1;">HOMBRES</div>
                <div style="font-size: 12px; color: #1565c0;">Postulantes</div>
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <!-- Registrados -->
              <div style="background: rgba(255,255,255,0.5); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 11px; font-weight: 700; color: #1565c0; margin-bottom: 8px;">REGISTRADOS</div>
                <div style="font-size: 32px; font-weight: 800; color: #1976d2;" id="statHombresRegistrados">0</div>
              </div>
              
              <!-- Recibidos -->
              <div style="background: rgba(255,255,255,0.5); border-radius: 12px; padding: 16px; text-align: center;">
                <div style="font-size: 11px; font-weight: 700; color: #1565c0; margin-bottom: 8px;">RECIBIDOS</div>
                <div style="font-size: 32px; font-weight: 800; color: #1976d2;" id="statHombresRecibidos">0</div>
              </div>
            </div>
          </div>
          
        </div>
      </div>
      
      <!-- ‚úÖ ESTAD√çSTICAS POR √ÅREA -->
      <div>
        <h3 style="margin-bottom: 16px; color: var(--muted);">üè¢ Postulantes por √Årea</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px;" id="statsAreas">
          <!-- Se llenar√° din√°micamente con JavaScript -->
        </div>
      </div>
    </section>

    <section class="panel tab" id="postulantes" hidden>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="margin:0;">Postulantes</h2>
        <div style="display:flex; gap:8px;">
          <a href="/admin/export/csv" class="btn" style="background:var(--success);color:#fff;">üìÑ Exportar CSV</a>
          <a href="/admin/export/excel" class="btn" style="background:var(--blue-2);color:#fff;">üìä Exportar Excel</a>
        </div>
      </div>

      <!-- SUB-PESTA√ëAS -->
      <div class="sub-tabs">
        <button class="sub-tab-btn active" data-subtab="registrados">
          üìù Postulantes Registrados
          <span class="sub-badge" id="badgeRegistrados">{{ total_pendientes if total_pendientes is defined else 0 }}</span>
        </button>
        <button class="sub-tab-btn" data-subtab="recibidos">
          ‚úÖ Postulantes Recibidos
          <span class="sub-badge" id="badgeRecibidos">{{ total_postulantes }}</span>
        </button>
      </div>

      <!-- PESTA√ëA: POSTULANTES REGISTRADOS (PENDIENTES) -->
      <div class="sub-tab-content" id="registrados">
        <div class="table-wrapper" id="tableWrapperRegistrados">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>√Årea</th>
                <th>Convocatoria</th>
                <th>Apellidos</th>
                <th>Nombres</th>
                <th>Tipo Doc</th>
                <th>N¬∞ Doc</th>
                <th>Fecha Nacimiento</th>
                <th>Sexo</th>
                <th>Celular</th>
                <th>Correo</th>
                <th>FF.AA.</th>
                <th>Discapacidad</th>
                <th>Tipo Discapacidad</th>
                <th>Fecha Registro</th>
              </tr>
            </thead>
            <tbody id="postulantesRegistradosTableBody">
              {% if postulantes_pendientes %}
                {% for p in postulantes_pendientes %}
                <tr data-id="{{ p.id }}">
                  <td class="td-num-reg">{{ loop.index }}</td>
                  <td>{{ p.area or '-' }}</td>
                  <td>{{ p.convocatoria }}</td>
                  <td class="apellidos">{{ p.apellidos }}</td>
                  <td class="nombres">{{ p.nombres }}</td>
                  <td>{{ p.tipo_documento }}</td>
                  <td>{{ p.numero_documento }}</td>
                  <td>{{ p.fecha_nacimiento }}</td>
                  <td>{{ p.sexo }}</td>
                  <td>{{ p.celular }}</td>
                  <td>{{ p.correo }}</td>
                  <td>{{ p.fuerzas_armadas or '-' }}</td>
                  <td>{{ p.tiene_discapacidad or '-' }}</td>
                  <td>{{ p.tipo_discapacidad or '-' }}</td>
                  <td>{{ p.created_at }}</td>
                </tr>
                {% endfor %}
              {% else %}
                <tr id="emptyRowRegistrados">
                  <td colspan="15" style="text-align:center;padding:18px;color:var(--muted);">
                    ‚úÖ No hay postulantes registrados pendientes
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- PESTA√ëA: POSTULANTES RECIBIDOS (ATENDIDOS) -->
      <div class="sub-tab-content" id="recibidos" hidden>
        <div class="table-wrapper" id="tableWrapperRecibidos">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>√Årea</th>
                <th>Convocatoria</th>
                <th>Apellidos</th>
                <th>Nombres</th>
                <th>Tipo Doc</th>
                <th>N¬∞ Doc</th>
                <th>Fecha Nacimiento</th>
                <th>Sexo</th>
                <th>Celular</th>
                <th>Correo</th>
                <th>FF.AA.</th>
                <th>Discapacidad</th>
                <th>Tipo Discapacidad</th>
                <th>Fecha Registro</th>
                <th>Usuario</th>
                <th>Fecha Atenci√≥n</th>
                <th>Eliminar</th>
              </tr>
            </thead>
            <tbody id="postulantesTableBody">
              {% for p in postulantes %}
              <tr data-id="{{ p.id }}">
                <td class="td-num">{{ loop.index }}</td>
                <td>{{ p.area or '-' }}</td>
                <td>{{ p.convocatoria }}</td>
                <td class="apellidos">{{ p.apellidos }}</td>
                <td class="nombres">{{ p.nombres }}</td>
                <td>{{ p.tipo_documento }}</td>
                <td>{{ p.numero_documento }}</td>
                <td>{{ p.fecha_nacimiento }}</td>
                <td>{{ p.sexo }}</td>
                <td>{{ p.celular }}</td>
                <td>{{ p.correo }}</td>
                <td>{{ p.fuerzas_armadas or '-' }}</td>
                <td>{{ p.tiene_discapacidad or '-' }}</td>
                <td>{{ p.tipo_discapacidad or '-' }}</td>
                <td>{{ p.created_at }}</td>
                <td>{{ p.usuario_atendio }}</td>
                <td>{{ p.fecha_atencion }}</td>
                <td>
                  <button class="btn-delete js-eliminar-postulante" data-id="{{ p.id }}" title="Eliminar postulante">
                    ‚úï
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- USUARIOS -->
    <section class="panel tab" id="usuarios" hidden>
      <h2>Usuarios del sistema</h2>

      <div class="table-wrapper" style="max-height: 400px;">
        <table>
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Contrase√±a</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Acci√≥n</th>
              <th>Eliminar</th>
            </tr>
          </thead>
          <tbody id="usuariosTableBody">
            {% for u in usuarios %}
            {% set activo = (u.estado | int) == 1 %}
            <tr data-username="{{ u.username }}">
              <td class="username">{{ u.username }}</td>
              <td class="password-cell">
                <span class="password-hidden">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                <button class="btn-eye js-toggle-password" title="Mostrar/Ocultar contrase√±a">
                  üëÅÔ∏è
                </button>
              </td>
              <td>{{ u.rol }}</td>
              <td class="estado-cell">
                {% if activo %}
                  <span class="badge badge-ok">Activo</span>
                {% else %}
                  <span class="badge badge-off">Inactivo</span>
                {% endif %}
              </td>
              <td class="acciones-cell">
                {% if u.username != 'admin' %}

                <button class="btn btn-activar"
                  style="background:var(--success);color:#fff; opacity:{{ '0.4' if activo else '1' }}"
                  {% if activo %}disabled{% endif %}
                  onclick="activarUsuario('{{ u.username }}')">
                  Activar
                </button>

                <button class="btn btn-danger btn-desactivar"
                  style="opacity:{{ '1' if activo else '0.4' }}"
                  {% if not activo %}disabled{% endif %}
                  onclick="desactivarUsuario('{{ u.username }}')">
                  Desactivar
                </button>

                {% else %}
                  ‚Äî
                {% endif %}
              </td>
              <td>
                {% if u.username != 'admin' %}
                <button class="btn-delete js-eliminar-usuario" data-username="{{ u.username }}" title="Eliminar usuario">
                  ‚úï
                </button>
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">Crear usuario</h3>

      <form id="formUsuario" style="display:flex; gap:8px; flex-wrap:wrap;">
        <input class="btn" name="username" placeholder="Usuario" required>
        <input class="btn" type="password" name="password" placeholder="Contrase√±a" required>
        <select name="rol" class="btn" required>
          <option value="">Rol</option>
          <option value="usuario">Usuario</option>
          <option value="admin">Administrador</option>
        </select>
        <button class="btn" type="submit">Crear</button>
      </form>
    </section>

    <section class="panel tab" id="logs" hidden>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="margin:0;">Logs del sistema</h2>
        <button class="btn" id="btnLimpiarLogs" style="background:var(--danger);color:#fff;">
          üóëÔ∏è Eliminar todos los logs
        </button>
      </div>
      <p style="font-size:12px;color:var(--muted);margin-top:0;">
        Mostrando los √∫ltimos 100 registros.
      </p>
      
      <div class="table-wrapper" style="max-height: 500px;">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Usuario</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            {% for l in logs %}
            <tr>
              <td>{{ l.fecha }}</td>
              <td>{{ l.usuario }}</td>
              <td>{{ l.accion }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

  </main>
</div>

<!-- MODAL GEN√âRICO -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">T√≠tulo</h3>
    </div>
    <div class="modal-body" id="modalBody">
      Mensaje
    </div>
    <div class="modal-footer" id="modalFooter">
      <!-- Botones se insertan din√°micamente -->
    </div>
  </div>
</div>

<script>
  function updateDateTime(){
    document.getElementById("datetime").textContent =
      new Date().toLocaleString("es-PE");
  }
  updateDateTime();
  setInterval(updateDateTime,1000);

  const buttons = document.querySelectorAll(".side-btn");
  const tabs = document.querySelectorAll(".tab");

  buttons.forEach(b=>{
    b.addEventListener("click",()=>{
      buttons.forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      const id = b.dataset.tab;
      tabs.forEach(t=>t.hidden = (t.id !== id));
    });
  });

  // SUB-PESTA√ëAS DE POSTULANTES
  const subTabButtons = document.querySelectorAll(".sub-tab-btn");
  const subTabContents = document.querySelectorAll(".sub-tab-content");

  subTabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      subTabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      
      const targetId = btn.dataset.subtab;
      subTabContents.forEach(content => {
        if (content.id === targetId) {
          content.hidden = false;
        } else {
          content.hidden = true;
        }
      });
    });
  });
</script>

<script>
// ==========================================
// SCROLL HORIZONTAL CON RUEDA DEL MOUSE
// ==========================================
const tableWrapperRegistrados = document.getElementById('tableWrapperRegistrados');
const tableWrapperRecibidos = document.getElementById('tableWrapperRecibidos');

[tableWrapperRegistrados, tableWrapperRecibidos].forEach(wrapper => {
  if (wrapper) {
    wrapper.addEventListener('wheel', (e) => {
      if (wrapper.scrollWidth > wrapper.clientWidth) {
        e.preventDefault();
        wrapper.scrollLeft += e.deltaY;
      }
    });
  }
});
</script>

<script>
// ==========================================
// MOSTRAR/OCULTAR CONTRASE√ëAS
// ==========================================
// Map para almacenar contrase√±as en cache (username -> password)
const passwordsMap = new Map();

// Event listener para botones de ojo
document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('js-toggle-password')) {
    const btn = e.target;
    const row = btn.closest('tr');
    const username = row.dataset.username;
    const passwordCell = row.querySelector('.password-cell');
    const passwordSpan = passwordCell.querySelector('.password-hidden');
    
    // Verificar si est√° oculta o visible
    const isHidden = passwordSpan.textContent === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    
    if (isHidden) {
      // Mostrar contrase√±a - obtener del servidor si no est√° en cache
      if (!passwordsMap.has(username)) {
        try {
          const res = await fetch('/api/obtener-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username })
          });
          
          const data = await res.json();
          
          if (data.ok && data.password) {
            passwordsMap.set(username, data.password);
          } else {
            await showModal({
              title: 'Error',
              message: 'No se pudo obtener la contrase√±a',
              icon: true,
              type: 'error'
            });
            return;
          }
        } catch (err) {
          await showModal({
            title: 'Error',
            message: 'Error de conexi√≥n',
            icon: true,
            type: 'error'
          });
          return;
        }
      }
      
      // Mostrar contrase√±a
      passwordSpan.textContent = passwordsMap.get(username);
      btn.textContent = 'üôà';
      btn.title = 'Ocultar contrase√±a';
    } else {
      // Ocultar contrase√±a
      passwordSpan.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
      btn.textContent = 'üëÅÔ∏è';
      btn.title = 'Mostrar contrase√±a';
    }
  }
});
</script>

<script>
// ==========================================
// CARGAR POSTULANTES REGISTRADOS (PENDIENTES)
// ==========================================
async function cargarPostulantesRegistrados() {
  try {
    const res = await fetch('/api/postulantes/registrados');
    const data = await res.json();
    
    if (data.ok && data.items) {
      const tbody = document.getElementById('postulantesRegistradosTableBody');
      tbody.innerHTML = '';
      
      if (data.items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="14" style="text-align:center;padding:20px;color:#6b7280;">No hay postulantes registrados pendientes</td></tr>';
        return;
      }
      
      data.items.forEach((p, index) => {
        const tr = document.createElement('tr');
        tr.dataset.id = p.id;
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${p.area || '-'}</td>
          <td>${p.convocatoria}</td>
          <td>${p.apellidos}</td>
          <td>${p.nombres}</td>
          <td>${p.tipo_documento}</td>
          <td>${p.numero_documento}</td>
          <td>${p.fecha_nacimiento}</td>
          <td>${p.sexo}</td>
          <td>${p.celular}</td>
          <td>${p.correo}</td>
          <td>${p.fuerzas_armadas || '-'}</td>
          <td>${p.tiene_discapacidad || '-'}</td>
          <td>${p.tipo_discapacidad || '-'}</td>
          <td>${p.created_at}</td>
        `;
        tbody.appendChild(tr);
      });
    }
  } catch (err) {
    console.error('Error cargando postulantes registrados:', err);
  }
}

cargarPostulantesRegistrados();
setInterval(cargarPostulantesRegistrados, 5000);
</script>

<script>
// SISTEMA DE MODALES
const modalOverlay = document.getElementById('modalOverlay');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalFooter = document.getElementById('modalFooter');

function showModal(config) {
  return new Promise((resolve) => {
    modalTitle.textContent = config.title || 'Aviso';
    
    let bodyHTML = '';
    if (config.icon) {
      const iconClass = config.type || 'info';
      const icons = {
        success: '‚úì',
        error: '‚úï',
        warning: '‚ö†',
        info: '‚Ñπ'
      };
      bodyHTML += `<div class="modal-icon ${iconClass}">${icons[iconClass] || icons.info}</div>`;
    }
    bodyHTML += `<div style="text-align:center">${config.message || ''}</div>`;
    modalBody.innerHTML = bodyHTML;
    
    modalFooter.innerHTML = '';
    
    if (config.type === 'confirm') {
      const btnCancel = document.createElement('button');
      btnCancel.className = 'modal-btn modal-btn-cancel';
      btnCancel.textContent = config.cancelText || 'Cancelar';
      btnCancel.onclick = () => {
        closeModal();
        resolve(false);
      };
      
      const btnConfirm = document.createElement('button');
      btnConfirm.className = `modal-btn modal-btn-${config.confirmClass || 'confirm'}`;
      btnConfirm.textContent = config.confirmText || 'Aceptar';
      btnConfirm.onclick = () => {
        closeModal();
        resolve(true);
      };
      
      modalFooter.appendChild(btnCancel);
      modalFooter.appendChild(btnConfirm);
    } else {
      const btnOk = document.createElement('button');
      btnOk.className = 'modal-btn modal-btn-confirm';
      btnOk.textContent = 'Aceptar';
      btnOk.onclick = () => {
        closeModal();
        resolve(true);
      };
      modalFooter.appendChild(btnOk);
    }
    
    modalOverlay.classList.add('active');
  });
}

function closeModal() {
  modalOverlay.classList.remove('active');
}

modalOverlay.addEventListener('click', (e) => {
  if (e.target === modalOverlay) {
    closeModal();
  }
});
</script>

<script>
// CREAR USUARIO
document.getElementById("formUsuario").addEventListener("submit", async (e) => {
  e.preventDefault();
  const f = e.target;

  const username = f.username.value;
  const password = f.password.value;
  const rol = f.rol.value;

  const res = await fetch("/api/crear-usuario", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: username,
      password: password,
      rol: rol
    })
  });

  const r = await res.json();
  if (r.ok) {
    //  Guardar contrase√±a en cache
    passwordsMap.set(username, password);
    
    await showModal({
      title: 'Usuario creado',
      message: `El usuario <strong>${username}</strong> ha sido creado exitosamente.`,
      icon: true,
      type: 'success'
    });
    
    const tbody = document.getElementById("usuariosTableBody");
    const newRow = document.createElement("tr");
    newRow.className = "new-row";
    newRow.setAttribute("data-username", username);
    
    newRow.innerHTML = `
      <td class="username">${username}</td>
      <td class="password-cell">
        <span class="password-hidden">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
        <button class="btn-eye js-toggle-password" title="Mostrar contrase√±a">
          üëÅÔ∏è
        </button>
      </td>
      <td>${rol}</td>
      <td class="estado-cell">
        <span class="badge badge-ok">Activo</span>
      </td>
      <td class="acciones-cell">
        <button class="btn btn-activar"
          style="background:var(--success);color:#fff; opacity:0.4"
          disabled
          onclick="activarUsuario('${username}')">
          Activar
        </button>
        <button class="btn btn-danger btn-desactivar"
          style="opacity:1"
          onclick="desactivarUsuario('${username}')">
          Desactivar
        </button>
      </td>
      <td>
        <button class="btn-delete js-eliminar-usuario" data-username="${username}" title="Eliminar usuario">
          ‚úï
        </button>
      </td>
    `;
    
    tbody.appendChild(newRow);
    f.reset();
  } else {
    await showModal({
      title: 'Error',
      message: r.error || 'No se pudo crear el usuario',
      icon: true,
      type: 'error'
    });
  }
});
</script>

<script>
// DESACTIVAR USUARIO
async function desactivarUsuario(username) {
  const confirmed = await showModal({
    title: '¬øDesactivar usuario?',
    message: `¬øEst√°s seguro de que deseas desactivar al usuario <strong>${username}</strong>?`,
    icon: true,
    type: 'confirm',
    confirmText: 'Desactivar',
    cancelText: 'Cancelar',
    confirmClass: 'danger'
  });
  
  if (!confirmed) return;
  
  const res = await fetch("/api/desactivar-usuario", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username })
  });
  
  const r = await res.json();
  if (r.ok) {
    const row = document.querySelector(`tr[data-username="${username}"]`);
    if (row) {
      const estadoCell = row.querySelector(".estado-cell");
      estadoCell.innerHTML = '<span class="badge badge-off">Inactivo</span>';
      
      const btnActivar = row.querySelector(".btn-activar");
      const btnDesactivar = row.querySelector(".btn-desactivar");
      
      btnActivar.disabled = false;
      btnActivar.style.opacity = "1";
      
      btnDesactivar.disabled = true;
      btnDesactivar.style.opacity = "0.4";
    }
    
    await showModal({
      title: 'Usuario desactivado',
      message: `El usuario <strong>${username}</strong> ha sido desactivado.`,
      icon: true,
      type: 'success'
    });
  } else {
    await showModal({
      title: 'Error',
      message: r.error || 'No se pudo desactivar el usuario',
      icon: true,
      type: 'error'
    });
  }
}
</script>

<script>
// ACTIVAR USUARIO
async function activarUsuario(username) {
  const confirmed = await showModal({
    title: '¬øActivar usuario?',
    message: `¬øEst√°s seguro de que deseas activar al usuario <strong>${username}</strong>?`,
    icon: true,
    type: 'confirm',
    confirmText: 'Activar',
    cancelText: 'Cancelar',
    confirmClass: 'success'
  });
  
  if (!confirmed) return;
  
  const res = await fetch("/api/activar-usuario", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username })
  });
  
  const r = await res.json();
  if (r.ok) {
    const row = document.querySelector(`tr[data-username="${username}"]`);
    if (row) {
      const estadoCell = row.querySelector(".estado-cell");
      estadoCell.innerHTML = '<span class="badge badge-ok">Activo</span>';
      
      const btnActivar = row.querySelector(".btn-activar");
      const btnDesactivar = row.querySelector(".btn-desactivar");
      
      btnActivar.disabled = true;
      btnActivar.style.opacity = "0.4";
      
      btnDesactivar.disabled = false;
      btnDesactivar.style.opacity = "1";
    }
    
    await showModal({
      title: 'Usuario activado',
      message: `El usuario <strong>${username}</strong> ha sido activado correctamente.`,
      icon: true,
      type: 'success'
    });
  } else {
    await showModal({
      title: 'Error',
      message: r.error || 'No se pudo activar el usuario',
      icon: true,
      type: 'error'
    });
  }
}
</script>

<script>
// ELIMINAR POSTULANTE (ADMIN)
document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('js-eliminar-postulante')) {
    const btn = e.target;
    const id = btn.dataset.id;
    const row = document.querySelector(`#postulantesTableBody tr[data-id="${id}"]`);
    
    if (!row) return;
    
    const nombre = row.querySelector('.apellidos').textContent;
    
    const confirmed = await showModal({
      title: '¬øEliminar postulante?',
      message: `¬øEst√°s seguro de eliminar a <strong>${nombre}</strong>? Esta acci√≥n no se puede deshacer.`,
      icon: true,
      type: 'confirm',
      confirmText: 'S√≠, eliminar',
      cancelText: 'Cancelar',
      confirmClass: 'danger'
    });
    
    if (!confirmed) return;
    
    try {
      const res = await fetch(`/api/eliminar/${id}`, {
        method: 'POST'
      });
      
      const data = await res.json();
      
      if (data.ok) {
        row.classList.add('removing-row');
        setTimeout(() => {
          row.remove();
          renumerarPostulantes();
          actualizarBadgeRecibidos();
        }, 300);
        
        await showModal({
          title: 'Postulante eliminado',
          message: `Se elimin√≥ a <strong>${nombre}</strong> del sistema.`,
          icon: true,
          type: 'success'
        });
      } else {
        await showModal({
          title: 'Error',
          message: data.error || 'No se pudo eliminar',
          icon: true,
          type: 'error'
        });
      }
    } catch (err) {
      await showModal({
        title: 'Error',
        message: 'Ocurri√≥ un error de conexi√≥n',
        icon: true,
        type: 'error'
      });
    }
  }
});

function renumerarPostulantes() {
  const rows = document.querySelectorAll('#postulantesTableBody tr');
  rows.forEach((row, index) => {
    const numCell = row.querySelector('.td-num');
    if (numCell) {
      numCell.textContent = index + 1;
    }
  });
}

function actualizarBadgeRecibidos() {
  const rows = document.querySelectorAll('#postulantesTableBody tr');
  const badge = document.getElementById('badgeRecibidos');
  if (badge) {
    badge.textContent = rows.length;
  }
}
</script>

<script>
// ELIMINAR USUARIO (ADMIN)
document.addEventListener('click', async (e) => {
  if (e.target.classList.contains('js-eliminar-usuario')) {
    const btn = e.target;
    const username = btn.dataset.username;
    const row = document.querySelector(`#usuariosTableBody tr[data-username="${username}"]`);
    
    if (!row || username === 'admin') return;
    
    const nombreUsuario = row.querySelector('.username').textContent;
    
    const confirmed = await showModal({
      title: '¬øEliminar usuario?',
      message: `¬øEst√°s seguro de eliminar al usuario <strong>${nombreUsuario}</strong>?<br><br>‚ö†Ô∏è Esta acci√≥n no se puede deshacer y el usuario no podr√° volver a acceder al sistema.`,
      icon: true,
      type: 'confirm',
      confirmText: 'S√≠, eliminar',
      cancelText: 'Cancelar',
      confirmClass: 'danger'
    });
    
    if (!confirmed) return;
    
    try {
      const res = await fetch('/api/eliminar-usuario', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username })
      });
      
      const data = await res.json();
      
      if (data.ok) {
        row.classList.add('removing-row');
        setTimeout(() => {
          row.remove();
        }, 300);
        
        await showModal({
          title: 'Usuario eliminado',
          message: `El usuario <strong>${nombreUsuario}</strong> ha sido eliminado del sistema.`,
          icon: true,
          type: 'success'
        });
      } else {
        await showModal({
          title: 'Error',
          message: data.error || 'No se pudo eliminar el usuario',
          icon: true,
          type: 'error'
        });
      }
    } catch (err) {
      await showModal({
        title: 'Error',
        message: 'Ocurri√≥ un error de conexi√≥n',
        icon: true,
        type: 'error'
      });
    }
  }
});
</script>

<script>
// LIMPIAR LOGS ANTIGUOS
const btnLimpiarLogs = document.getElementById('btnLimpiarLogs');
if (btnLimpiarLogs) {
  btnLimpiarLogs.addEventListener('click', async () => {
    const confirmed = await showModal({
      title: '¬øEliminar todos los logs?',
      message: '‚ö†Ô∏è Se eliminar√°n <strong>TODOS</strong> los registros de logs del sistema. Esta acci√≥n no se puede deshacer.',
      icon: true,
      type: 'confirm',
      confirmText: 'S√≠, eliminar todo',
      cancelText: 'Cancelar',
      confirmClass: 'danger'
    });
    
    if (!confirmed) return;
    
    try {
      const res = await fetch('/api/limpiar-logs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const data = await res.json();
      
      if (data.ok) {
        await showModal({
          title: 'Logs eliminados',
          message: `Se eliminaron <strong>${data.eliminados}</strong> registro(s) del sistema.`,
          icon: true,
          type: 'success'
        });
        
        location.reload();
      } else {
        await showModal({
          title: 'Error',
          message: data.error || 'No se pudieron eliminar los logs',
          icon: true,
          type: 'error'
        });
      }
    } catch (err) {
      await showModal({
        title: 'Error',
        message: 'Ocurri√≥ un error de conexi√≥n',
        icon: true,
        type: 'error'
      });
    }
  });
}
</script>

<script>
// ==========================================
// POLLING AUTOM√ÅTICO - ADMIN
// ==========================================
let maxIdAdmin = 0;

function initMaxIdAdmin() {
  const rows = document.querySelectorAll('#postulantesTableBody tr');
  rows.forEach(row => {
    const id = parseInt(row.dataset.id);
    if (id > maxIdAdmin) maxIdAdmin = id;
  });
}

initMaxIdAdmin();

function addNewRowAdmin(p) {
  const tbody = document.getElementById('postulantesTableBody');
  
  const tr = document.createElement('tr');
  tr.className = 'new-row';
  tr.dataset.id = p.id;
  
  const currentRows = tbody.querySelectorAll('tr').length;
  const rowNum = currentRows + 1;
  
  tr.innerHTML = `
    <td class="td-num">${rowNum}</td>
    <td>${p.area || '-'}</td>
    <td>${p.convocatoria}</td>
    <td class="apellidos">${p.apellidos_nombres}</td>
    <td>${p.tipo_documento}</td>
    <td>${p.numero_documento}</td>
    <td>${p.fecha_nacimiento}</td>
    <td>${p.sexo}</td>
    <td>${p.celular}</td>
    <td>${p.correo}</td>
    <td>${p.fuerzas_armadas || '-'}</td>
    <td>${p.tiene_discapacidad || '-'}</td>
    <td>${p.tipo_discapacidad || '-'}</td>
    <td>${p.created_at}</td>
    <td>${p.usuario_atendio}</td>
    <td>${p.fecha_atencion}</td>
    <td>
      <button class="btn-delete js-eliminar-postulante" data-id="${p.id}" title="Eliminar postulante">
        ‚úï
      </button>
    </td>
  `;
  
  tbody.insertBefore(tr, tbody.firstChild);
  renumerarPostulantes();
  
  setTimeout(() => {
    tr.style.background = '#e6f4ea';
    setTimeout(() => {
      tr.style.background = '';
    }, 2000);
  }, 10);
}

async function pollNewPostulantesAdmin() {
  try {
    const res = await fetch(`/api/postulantes/atendidos-nuevos?after_id=${maxIdAdmin}`);
    const data = await res.json();
    
    if (data.ok && data.items && data.items.length > 0) {
      data.items.forEach(p => {
        addNewRowAdmin(p);
        if (p.id > maxIdAdmin) maxIdAdmin = p.id;
        
        const rowRegistrado = document.querySelector(`#postulantesRegistradosTableBody tr[data-id="${p.id}"]`);
        if (rowRegistrado) {
          rowRegistrado.remove();
          renumerarRegistrados();
        }
      });
      
      showNotificationAdmin(`üì• ${data.items.length} nuevo(s) postulante(s) recibido(s)`);
      actualizarBadgeRecibidos();
    }
  } catch (err) {
    console.error('Error polling admin:', err);
  }
}

if (document.getElementById('postulantesTableBody')) {
  setInterval(pollNewPostulantesAdmin, 3000);
}

// POLLING PARA POSTULANTES REGISTRADOS
let maxIdRegistrados = 0;

function initMaxIdRegistrados() {
  const rows = document.querySelectorAll('#postulantesRegistradosTableBody tr');
  rows.forEach(row => {
    const id = parseInt(row.dataset.id);
    if (id > maxIdRegistrados) maxIdRegistrados = id;
  });
}

initMaxIdRegistrados();

function addNewRowRegistrados(p) {
  const tbody = document.getElementById('postulantesRegistradosTableBody');
  
  const emptyRow = tbody.querySelector('#emptyRowRegistrados');
  if (emptyRow) emptyRow.remove();
  
  const tr = document.createElement('tr');
  tr.dataset.id = p.id;
  
  const currentRows = tbody.querySelectorAll('tr').length;
  const rowNum = currentRows + 1;
  
  tr.innerHTML = `
    <td class="td-num-reg">${rowNum}</td>
    <td>${p.area || '-'}</td>
    <td>${p.convocatoria}</td>
    <td class="apellidos">${p.apellidos_nombres}</td>
    <td>${p.tipo_documento}</td>
    <td>${p.numero_documento}</td>
    <td>${p.fecha_nacimiento}</td>
    <td>${p.sexo}</td>
    <td>${p.celular}</td>
    <td>${p.correo}</td>
    <td>${p.fuerzas_armadas || '-'}</td>
    <td>${p.tiene_discapacidad || '-'}</td>
    <td>${p.tipo_discapacidad || '-'}</td>
    <td>${p.created_at}</td>
  `;
  
  tbody.insertBefore(tr, tbody.firstChild);
  renumerarRegistrados();
  
  setTimeout(() => {
    tr.style.background = '#e6f4ea';
    setTimeout(() => {
      tr.style.background = '';
    }, 2000);
  }, 10);
}

function renumerarRegistrados() {
  const rows = document.querySelectorAll('#postulantesRegistradosTableBody tr');
  rows.forEach((row, index) => {
    const numCell = row.querySelector('.td-num-reg');
    if (numCell) {
      numCell.textContent = index + 1;
    }
  });
  
  const badge = document.getElementById('badgeRegistrados');
  if (badge) {
    badge.textContent = rows.length;
  }
}

async function pollPostulantesRegistrados() {
  try {
    const res = await fetch(`/api/postulantes/pendientes-nuevos?after_id=${maxIdRegistrados}`);
    const data = await res.json();
    
    if (data.ok && data.items && data.items.length > 0) {
      data.items.forEach(p => {
        addNewRowRegistrados(p);
        if (p.id > maxIdRegistrados) maxIdRegistrados = p.id;
      });
      
      showNotificationAdmin(`üìù ${data.items.length} nuevo(s) postulante(s) registrado(s)`);
    }
  } catch (err) {
    console.error('Error polling registrados:', err);
  }
}

if (document.getElementById('postulantesRegistradosTableBody')) {
  setInterval(pollPostulantesRegistrados, 3000);
}

function showNotificationAdmin(message) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: linear-gradient(135deg, #0f9d58 0%, #0d7d46 100%);
    color: white;
    padding: 14px 20px;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    font-weight: 700;
    font-size: 13px;
    z-index: 9999;
    animation: slideInRight 0.3s ease-out;
  `;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease-out';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}
</script>

<script>
// ==========================================
// CARGAR ESTAD√çSTICAS 
// ==========================================
async function cargarEstadisticas() {
  try {
    const res = await fetch('/api/estadisticas');
    const data = await res.json();
    
    if (data.ok) {
      // Actualizar Postulantes por G√©nero
      document.getElementById('statMujeresRegistradas').textContent = data.registrados_mujeres || 0;
      document.getElementById('statHombresRegistrados').textContent = data.registrados_hombres || 0;
      document.getElementById('statMujeresRecibidas').textContent = data.recibidos_mujeres || 0;
      document.getElementById('statHombresRecibidos').textContent = data.recibidos_hombres || 0;
      
      // ‚úÖ Actualizar Estad√≠sticas por √Årea
      if (data.por_area) {
        const statsAreasContainer = document.getElementById('statsAreas');
        statsAreasContainer.innerHTML = '';
        
        const areaNames = {
          'GGRD': 'Gerencia de Gesti√≥n del Riesgo de Desastres',
          'GSCGA': 'Gerencia de Servicios a la Ciudad y Gesti√≥n Ambiental',
          'GFC': 'Gerencia de Fiscalizaci√≥n y Control',
          'GSC': 'Gerencia de Seguridad Ciudadana',
          'GDE': 'Gerencia de Desarrollo Econ√≥mico'
        };
        
        const areaIcons = {
          'GGRD': 'üö®',
          'GSCGA': 'üåø',
          'GFC': 'üëÆ',
          'GSC': 'üõ°Ô∏è',
          'GDE': 'üíº'
        };
        
        const areaColors = {
          'GGRD': { bg: 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)', primary: '#dc2626', secondary: '#991b1b' },
          'GSCGA': { bg: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)', primary: '#10b981', secondary: '#047857' },
          'GFC': { bg: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)', primary: '#3b82f6', secondary: '#1e40af' },
          'GSC': { bg: 'linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%)', primary: '#8b5cf6', secondary: '#6d28d9' },
          'GDE': { bg: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', primary: '#f59e0b', secondary: '#d97706' }
        };
        
        Object.entries(data.por_area).forEach(([codigo, total]) => {
          const card = document.createElement('div');
          const colors = areaColors[codigo] || areaColors['GGRD'];
          
          card.style.cssText = `
            background: ${colors.bg};
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          `;
          
          card.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
              <div style="width: 48px; height: 48px; background: ${colors.primary}; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;">
                ${areaIcons[codigo] || 'üìã'}
              </div>
              <div style="flex: 1;">
                <div style="font-size: 13px; font-weight: 700; color: ${colors.secondary};">${areaNames[codigo] || codigo}</div>
                <div style="font-size: 11px; color: ${colors.primary};">Total postulantes</div>
              </div>
            </div>
            <div style="font-size: 36px; font-weight: 800; color: ${colors.primary};">${total}</div>
            <div style="font-size: 11px; color: ${colors.primary}; margin-top: 4px;">postulantes</div>
          `;
          
          statsAreasContainer.appendChild(card);
        });
      }
    }
  } catch (err) {
    console.error('Error cargando estad√≠sticas:', err);
  }
}

cargarEstadisticas();
setInterval(cargarEstadisticas, 5000);
</script>

</body>
</html>