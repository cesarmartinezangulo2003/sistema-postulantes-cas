<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel Administrador</title>

  <style>
    :root{
      --blue:#003f8f; --blue-2:#0a56b5; --bg:#f4f6f9; --card:#ffffff;
      --border:#d7dbe2; --text:#1f2937; --muted:#6b7280; --danger:#b00020;
      --success:#0f9d58; --warning:#f59e0b;
      --shadow: 0 10px 22px rgba(0,0,0,.08); --radius: 12px;
    }
    *{ box-sizing:border-box; font-family: Arial, Helvetica, sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--text); overflow-x: hidden; }
    html{ overflow-x: hidden; }
    .topbar{ background:var(--blue); padding:14px 18px; display:flex; justify-content:space-between; align-items:center; color:#fff; position:sticky; top:0; z-index:10; box-shadow:0 6px 16px rgba(0,0,0,.12); }
    .topbar-left{ display:flex; align-items:center; gap:14px; }
    .topbar img{ height:44px; }
    .topbar-info{ font-size:12px; line-height:1.3; }
    .btn{ height:34px; padding:0 12px; border-radius:8px; border:none; cursor:pointer; font-size:11px; font-weight:700; display:inline-flex; align-items:center; gap:6px; background:#e5e7eb; transition: all 0.2s; }
    .btn:hover:not(:disabled){ transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; transform:none !important; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .status-bar{ display:flex; align-items:center; gap:8px; font-size:11px; font-weight:600; color:#fff; padding:5px 10px; background:rgba(255,255,255,0.15); border-radius:8px; }
    .status-dot{ width:8px; height:8px; border-radius:50%; background:#4ade80; animation:pulse 2s infinite; }
    .status-dot.offline{ background:#f87171; animation:none; }
    @keyframes pulse{ 0%,100%{opacity:1;} 50%{opacity:0.4;} }
    .badge{ padding:4px 8px; border-radius:8px; font-size:11px; font-weight:bold; }
    .badge-ok{ background:#e6f4ea; color:var(--success); }
    .badge-off{ background:#fdecea; color:var(--danger); }
    .container{ max-width:1400px; margin:18px auto; padding:0 18px; overflow-x:hidden; }
    .panel{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); margin-bottom:16px; overflow-x:hidden; }
    .table-wrapper{ width:100%; overflow-x:auto; overflow-y:auto; max-height:600px; margin-top:16px; border:1px solid var(--border); border-radius:8px; scrollbar-width:thin; scrollbar-color:var(--blue-2) #e5e7eb; }
    .table-wrapper::-webkit-scrollbar{ height:10px; width:10px; }
    .table-wrapper::-webkit-scrollbar-track{ background:#f1f1f1; border-radius:10px; }
    .table-wrapper::-webkit-scrollbar-thumb{ background:var(--blue-2); border-radius:10px; }
    .table-wrapper::-webkit-scrollbar-thumb:hover{ background:var(--blue); }
    table{ width:100%; min-width:1700px; border-collapse:separate; border-spacing:0; font-size:12px; }
    #usuarios table, #logs table{ min-width:100%; }
    thead th{ background:#f8fafc; padding:10px; font-weight:800; border-bottom:1px solid var(--border); position:sticky; top:0; z-index:2; }
    tbody td{ padding:10px; border-bottom:1px solid #eef2f7; white-space:nowrap; }
    .admin-layout{ display:flex; gap:16px; position:relative; }
    .admin-layout::before{ content:''; width:220px; min-width:220px; flex-shrink:0; }
    .sidebar{ width:220px; min-width:220px; background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px; display:flex; flex-direction:column; gap:8px; height:fit-content; position:fixed; top:90px; left:18px; min-height:300px; }
    .side-btn{ all:unset; padding:10px 12px; border-radius:10px; cursor:pointer; font-size:13px; font-weight:700; transition:all 0.2s; }
    .side-btn:hover{ background:#f3f4f6; }
    .side-btn.active{ background:#eaf2ff; color:var(--blue-2); }
    .content{ flex:1; min-width:0; }
    .search-bar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; padding:12px; background:#f8fafc; border-radius:10px; border:1px solid var(--border); }
    .search-input{ flex:1; min-width:200px; height:36px; padding:0 12px; border:1px solid var(--border); border-radius:8px; font-size:13px; outline:none; transition:border-color 0.2s; }
    .search-input:focus{ border-color:var(--blue-2); box-shadow:0 0 0 3px rgba(10,86,181,0.1); }
    .search-select{ height:36px; padding:0 10px; border:1px solid var(--border); border-radius:8px; font-size:12px; font-weight:600; outline:none; background:white; cursor:pointer; }
    .search-select:focus{ border-color:var(--blue-2); }
    .search-count{ font-size:12px; color:var(--muted); font-weight:600; white-space:nowrap; }
    .btn-clear-search{ height:36px; padding:0 12px; border-radius:8px; border:1px solid var(--border); background:white; font-size:12px; font-weight:700; cursor:pointer; color:var(--muted); transition:all 0.2s; }
    .btn-clear-search:hover{ background:#f3f4f6; color:var(--text); }
    .pagination-bar{ display:flex; align-items:center; justify-content:space-between; padding:12px 8px; border-top:1px solid var(--border); flex-wrap:wrap; gap:8px; }
    .pagination-info{ font-size:12px; color:var(--muted); font-weight:600; }
    .pagination-btns{ display:flex; gap:4px; align-items:center; flex-wrap:wrap; }
    .page-btn{ width:32px; height:32px; border-radius:8px; border:1px solid var(--border); background:white; font-size:12px; font-weight:700; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:center; }
    .page-btn:hover:not(:disabled){ background:#eaf2ff; border-color:var(--blue-2); color:var(--blue); }
    .page-btn.active{ background:var(--blue); color:white; border-color:var(--blue); }
    .page-btn:disabled{ opacity:0.3; cursor:not-allowed; }
    .page-size-select{ height:32px; padding:0 8px; border:1px solid var(--border); border-radius:8px; font-size:12px; font-weight:600; background:white; cursor:pointer; }
    .sub-tabs{ display:flex; gap:0; border-bottom:2px solid var(--border); margin-bottom:0; }
    .sub-tab-btn{ all:unset; padding:12px 24px; cursor:pointer; font-size:13px; font-weight:700; color:var(--muted); border-bottom:3px solid transparent; transition:all 0.2s; display:inline-flex; align-items:center; gap:8px; }
    .sub-tab-btn:hover{ background:#f9fafb; color:var(--text); }
    .sub-tab-btn.active{ color:var(--blue); border-bottom-color:var(--blue); background:#f0f4ff; }
    .sub-badge{ background:var(--blue-2); color:white; padding:2px 8px; border-radius:12px; font-size:11px; font-weight:700; }
    .sub-tab-btn.active .sub-badge{ background:var(--blue); }
    .sub-tab-content{ display:block; }
    .sub-tab-content[hidden]{ display:none; }
    @keyframes highlightNew{ 0%{background:#bbf7d0;} 100%{background:transparent;} }
    .highlight-new{ animation:highlightNew 2s ease-out; }
    .modal-overlay{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px); z-index:1000; align-items:center; justify-content:center; }
    .modal-overlay.active{ display:flex; }
    .modal{ background:white; border-radius:16px; padding:0; max-width:440px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
    .modal-header{ padding:24px 24px 16px; border-bottom:1px solid #e5e7eb; }
    .modal-title{ font-size:18px; font-weight:700; color:var(--text); margin:0; }
    .modal-body{ padding:24px; color:var(--muted); font-size:14px; line-height:1.6; }
    .modal-footer{ padding:16px 24px 24px; display:flex; gap:12px; justify-content:flex-end; }
    .modal-btn{ padding:10px 24px; border-radius:10px; border:none; font-size:13px; font-weight:700; cursor:pointer; transition:all 0.2s; }
    .modal-btn:hover{ transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
    .modal-btn-cancel{ background:#f3f4f6; color:var(--text); }
    .modal-btn-confirm{ background:var(--blue); color:white; }
    .modal-btn-danger{ background:var(--danger); color:white; }
    .modal-btn-success{ background:var(--success); color:white; }
    .modal-icon{ width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px; font-size:28px; }
    .modal-icon.success{ background:#e6f4ea; color:var(--success); }
    .modal-icon.error{ background:#fdecea; color:var(--danger); }
    .modal-icon.warning{ background:#fff4e5; color:#f59e0b; }
    .modal-icon.info{ background:#eaf2ff; color:var(--blue-2); }
    .btn-delete{ width:28px; height:28px; border-radius:6px; border:none; background:var(--danger); color:white; font-size:16px; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; transition:all 0.2s; }
    .btn-delete:hover{ background:#8b0017; transform:scale(1.1); }
    .btn-eye{ width:28px; height:28px; border-radius:6px; border:none; background:var(--blue-2); color:white; font-size:14px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; transition:all 0.2s; }
    .btn-eye:hover{ background:var(--blue); transform:scale(1.1); }
    .conexion-dot{ width:10px; height:10px; border-radius:50%; flex-shrink:0; transition: background 0.4s; }
    @media (max-width:1024px){ .container{ padding:0 12px; margin:12px auto; } .admin-layout{ flex-direction:column; } .admin-layout::before{ display:none; } .sidebar{ position:relative; width:100%; top:0; left:0; flex-direction:row; overflow-x:auto; gap:6px; padding:8px; min-height:unset; } .side-btn{ white-space:nowrap; font-size:12px; padding:8px 12px; } .panel{ padding:12px; } .table-wrapper{ max-height:500px; } }
    @media (max-width:768px){ .topbar{ padding:10px 12px; flex-wrap:wrap; } .topbar img{ height:36px; } .topbar-info{ font-size:10px; } .btn{ height:30px; padding:0 10px; font-size:10px; } .search-bar{ padding:8px; gap:6px; } .search-input{ min-width:150px; } .pagination-bar{ flex-direction:column; align-items:flex-start; } table{ font-size:10px; } thead th{ padding:8px 6px; font-size:10px; } tbody td{ padding:8px 6px; } }
  </style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <img src="/static/img/mml.png" alt="Logo MML">
    <div class="topbar-info">
      <div><strong>Administrador:</strong> {{ usuario }}</div>
      <div id="datetime"></div>
    </div>
  </div>
  <div style="display:flex;gap:10px;align-items:center;">
    <div class="status-bar">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">En l√≠nea</span>
    </div>
    <a href="/logout" class="btn btn-danger">üö™ Cerrar sesi√≥n</a>
  </div>
</div>

<!-- CSRF token disponible para JS -->
<meta name="csrf-token" content="{{ csrf_token }}">

<div class="container admin-layout">

  <!-- SIDEBAR con panel de conectados al fondo -->
  <aside class="sidebar">
    <button class="side-btn active" data-tab="stats">üìä Estad√≠sticas</button>
    <button class="side-btn" data-tab="postulantes">üìã Postulantes</button>
    <button class="side-btn" data-tab="usuarios">üë§ Usuarios</button>
    <button class="side-btn" data-tab="logs">üïí Logs</button>
    <button class="side-btn" data-tab="formulario">üìã Formulario</button>

    <!-- USUARIOS CONECTADOS EN SIDEBAR -->
    <div style="margin-top:auto;padding-top:12px;border-top:1px solid var(--border);">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <span style="font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;">Conectados</span>
        <span id="sidebarBadgeActivos" style="background:var(--blue);color:white;padding:1px 7px;border-radius:99px;font-size:11px;font-weight:700;">0</span>
      </div>
      <div id="sidebarListaActivos" style="display:flex;flex-direction:column;gap:5px;">
        <span style="font-size:11px;color:var(--muted);font-style:italic;">Cargando...</span>
      </div>
    </div>
  </aside>

  <main class="content">

    <!-- ESTAD√çSTICAS -->
    <section class="panel tab" id="stats">
      <h2 style="margin-bottom:24px;">üìä Estad√≠sticas del Sistema</h2>
      <div style="margin-bottom:32px;">
        <h3 style="margin-bottom:16px;color:var(--muted);">üë• Postulantes por G√©nero</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:16px;">
          <div style="background:linear-gradient(135deg,#fce4ec,#f8bbd0);border-radius:16px;padding:24px;box-shadow:0 4px 12px rgba(233,30,99,0.15);">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
              <div style="width:56px;height:56px;background:#ec407a;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:28px;color:white;">üë©</div>
              <div><div style="font-size:18px;font-weight:700;color:#880e4f;">MUJERES</div><div style="font-size:12px;color:#ad1457;">Postulantes</div></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div style="background:rgba(255,255,255,0.5);border-radius:12px;padding:16px;text-align:center;">
                <div style="font-size:11px;font-weight:700;color:#ad1457;margin-bottom:8px;">REGISTRADAS</div>
                <div style="font-size:32px;font-weight:800;color:#c2185b;" id="statMujeresRegistradas">0</div>
              </div>
              <div style="background:rgba(255,255,255,0.5);border-radius:12px;padding:16px;text-align:center;">
                <div style="font-size:11px;font-weight:700;color:#ad1457;margin-bottom:8px;">RECIBIDAS</div>
                <div style="font-size:32px;font-weight:800;color:#c2185b;" id="statMujeresRecibidas">0</div>
              </div>
            </div>
          </div>
          <div style="background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-radius:16px;padding:24px;box-shadow:0 4px 12px rgba(33,150,243,0.15);">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
              <div style="width:56px;height:56px;background:#2196f3;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:28px;color:white;">üë®</div>
              <div><div style="font-size:18px;font-weight:700;color:#0d47a1;">HOMBRES</div><div style="font-size:12px;color:#1565c0;">Postulantes</div></div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <div style="background:rgba(255,255,255,0.5);border-radius:12px;padding:16px;text-align:center;">
                <div style="font-size:11px;font-weight:700;color:#1565c0;margin-bottom:8px;">REGISTRADOS</div>
                <div style="font-size:32px;font-weight:800;color:#1976d2;" id="statHombresRegistrados">0</div>
              </div>
              <div style="background:rgba(255,255,255,0.5);border-radius:12px;padding:16px;text-align:center;">
                <div style="font-size:11px;font-weight:700;color:#1565c0;margin-bottom:8px;">RECIBIDOS</div>
                <div style="font-size:32px;font-weight:800;color:#1976d2;" id="statHombresRecibidos">0</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <h3 style="margin-bottom:16px;color:var(--muted);">üè¢ Postulantes por √Årea</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;" id="statsAreas"></div>
      </div>
    </section>

    <!-- POSTULANTES -->
    <section class="panel tab" id="postulantes" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px;">
        <h2 style="margin:0;">Postulantes</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <a href="/admin/export/excel" class="btn" style="background:var(--blue-2);color:#fff;">üìä Excel Recibidos</a>
          <a href="/admin/export/excel-pendientes" class="btn" style="background:#7c3aed;color:#fff;">üìä Excel Registrados</a>
        </div>
      </div>

      <div class="sub-tabs">
        <button class="sub-tab-btn active" data-subtab="registrados">
          üìù Registrados <span class="sub-badge" id="badgeRegistrados">0</span>
        </button>
        <button class="sub-tab-btn" data-subtab="recibidos">
          ‚úÖ Recibidos <span class="sub-badge" id="badgeRecibidos">0</span>
        </button>
      </div>

      <!-- REGISTRADOS -->
      <div class="sub-tab-content" id="registrados">
        <div class="search-bar" style="margin-top:16px;">
          <input class="search-input" id="searchRegistrados" placeholder="üîç Buscar por nombre, apellido o DNI..." oninput="filtrarRegistrados()">
          <select class="search-select" id="filtroSexoReg" onchange="filtrarRegistrados()">
            <option value="">Todos los g√©neros</option>
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
          </select>
          <select class="search-select" id="filtroAreaReg" onchange="filtrarRegistrados()">
            <option value="">Todas las √°reas</option>
          </select>
          <span class="search-count" id="countRegistrados">0 resultados</span>
          <button class="btn-clear-search" onclick="limpiarFiltrosRegistrados()">‚úï Limpiar</button>
        </div>
        <div class="table-wrapper" id="tableWrapperRegistrados">
          <table>
            <thead>
              <tr><th>#</th><th>√Årea</th><th>Convocatoria</th><th>Apellidos</th><th>Nombres</th>
              <th>Tipo Doc</th><th>N¬∞ Doc</th><th>Fecha Nacimiento</th><th>Sexo</th>
              <th>Celular</th><th>Correo</th><th>FF.AA.</th><th>Discapacidad</th>
              <th>Tipo Discapacidad</th><th>Fecha Registro</th><th>Eliminar</th></tr>
            </thead>
            <tbody id="tbodyRegistrados">
              <tr><td colspan="16" style="text-align:center;padding:18px;color:var(--muted);">‚è≥ Cargando...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination-bar">
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="pagination-info" id="infoRegistrados"></span>
            <select class="page-size-select" id="pageSizeReg" onchange="cambiarPagReg()">
              <option value="25">25 por p√°gina</option><option value="50">50 por p√°gina</option><option value="100">100 por p√°gina</option>
            </select>
          </div>
          <div class="pagination-btns" id="botonesRegistrados"></div>
        </div>
      </div>

      <!-- RECIBIDOS -->
      <div class="sub-tab-content" id="recibidos" hidden>
        <div class="search-bar" style="margin-top:16px;">
          <input class="search-input" id="searchRecibidos" placeholder="üîç Buscar por nombre, apellido o DNI..." oninput="filtrarRecibidos()">
          <select class="search-select" id="filtroSexoRec" onchange="filtrarRecibidos()">
            <option value="">Todos los g√©neros</option>
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
          </select>
          <select class="search-select" id="filtroAreaRec" onchange="filtrarRecibidos()">
            <option value="">Todas las √°reas</option>
          </select>
          <span class="search-count" id="countRecibidos">0 resultados</span>
          <button class="btn-clear-search" onclick="limpiarFiltrosRecibidos()">‚úï Limpiar</button>
        </div>
        <div class="table-wrapper" id="tableWrapperRecibidos">
          <table>
            <thead>
              <tr><th>#</th><th>√Årea</th><th>Convocatoria</th><th>Apellidos</th><th>Nombres</th>
              <th>Tipo Doc</th><th>N¬∞ Doc</th><th>Fecha Nacimiento</th><th>Sexo</th>
              <th>Celular</th><th>Correo</th><th>FF.AA.</th><th>Discapacidad</th>
              <th>Tipo Discapacidad</th><th>Fecha Registro</th><th>Usuario</th><th>Fecha Atenci√≥n</th><th>Eliminar</th></tr>
            </thead>
            <tbody id="tbodyRecibidos">
              <tr><td colspan="18" style="text-align:center;padding:18px;color:var(--muted);">‚è≥ Cargando...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination-bar">
          <div style="display:flex;align-items:center;gap:8px;">
            <span class="pagination-info" id="infoRecibidos"></span>
            <select class="page-size-select" id="pageSizeRec" onchange="cambiarPagRec()">
              <option value="25">25 por p√°gina</option><option value="50">50 por p√°gina</option><option value="100">100 por p√°gina</option>
            </select>
          </div>
          <div class="pagination-btns" id="botonesRecibidos"></div>
        </div>
      </div>
    </section>

    <!-- USUARIOS -->
    <section class="panel tab" id="usuarios" hidden>

      <!-- Usuarios conectados en tiempo real -->
      <div id="usuariosActivosPanel" style="margin-bottom:20px;background:linear-gradient(135deg,#eaf2ff,#dbeafe);border:1px solid #bfdbfe;border-radius:12px;padding:16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:10px;height:10px;border-radius:50%;background:#22c55e;animation:pulse 2s infinite;"></div>
            <span style="font-size:14px;font-weight:800;color:#1e3a8a;">Usuarios conectados ahora</span>
            <span id="badgeActivos" style="background:#003f8f;color:white;padding:3px 10px;border-radius:99px;font-size:12px;font-weight:700;">0</span>
          </div>
          <span style="font-size:11px;color:#6b7280;">Actualiza cada 10s</span>
        </div>
        <div id="listaActivos" style="display:flex;flex-wrap:wrap;gap:8px;">
          <span style="font-size:12px;color:#6b7280;font-style:italic;">Cargando...</span>
        </div>
      </div>

      <h2>Usuarios del sistema</h2>
      <div class="search-bar">
        <input class="search-input" id="searchUsuarios" placeholder="üîç Buscar por usuario o rol..." oninput="filtrarUsuarios()">
        <select class="search-select" id="filtroRolUsr" onchange="filtrarUsuarios()">
          <option value="">Todos los roles</option>
          <option value="admin">Administrador</option>
          <option value="usuario">Usuario</option>
        </select>
        <span class="search-count" id="countUsuarios">0 resultados</span>
        <button class="btn-clear-search" onclick="limpiarFiltrosUsuarios()">‚úï Limpiar</button>
      </div>
      <div class="table-wrapper" style="max-height:400px;">
        <table>
          <thead><tr><th>Usuario</th><th>Rol</th><th>Estado</th><th>Conexi√≥n</th><th>Contrase√±a</th><th>Acci√≥n</th><th>Eliminar</th></tr></thead>
          <tbody id="tbodyUsuarios">
            {% for u in usuarios %}
            {% set activo = (u.estado | int) == 1 %}
            <tr data-username="{{ u.username }}" data-rol="{{ u.rol }}">
              <td class="td-username">{{ u.username }}</td>
              <td>{{ u.rol }}</td>
              <td class="td-estado">
                {% if activo %}<span class="badge badge-ok">Activo</span>
                {% else %}<span class="badge badge-off">Inactivo</span>{% endif %}
              </td>
              <td class="td-conexion">
                <div style="display:flex;align-items:center;gap:6px;">
                  <div class="conexion-dot" style="background:#f87171;" title="Desconectado"></div>
                  <span class="conexion-label" style="font-size:11px;color:var(--muted);">Desconectado</span>
                </div>
              </td>
              <td>
                <button class="btn" style="background:#7c3aed;color:white;" onclick="cambiarPassword('{{ u.username }}')">üîë Cambiar</button>
              </td>
              <td class="td-acciones">
                {% if u.username != 'admin' %}
                <button class="btn btn-activar" style="background:var(--success);color:#fff;opacity:{{ '0.4' if activo else '1' }}" {% if activo %}disabled{% endif %} onclick="activarUsuario('{{ u.username }}')">Activar</button>
                <button class="btn btn-danger btn-desactivar" style="opacity:{{ '1' if activo else '0.4' }}" {% if not activo %}disabled{% endif %} onclick="desactivarUsuario('{{ u.username }}')">Desactivar</button>
                {% else %}‚Äî{% endif %}
              </td>
              <td>
                {% if u.username != 'admin' %}
                <button class="btn-delete js-del-usuario" data-username="{{ u.username }}">‚úï</button>
                {% else %}‚Äî{% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="pagination-bar">
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="pagination-info" id="infoUsuarios"></span>
          <select class="page-size-select" id="pageSizeUsr" onchange="cambiarPagUsr()">
            <option value="10">10 por p√°gina</option><option value="25">25 por p√°gina</option><option value="50">50 por p√°gina</option>
          </select>
        </div>
        <div class="pagination-btns" id="botonesUsuarios"></div>
      </div>
      <h3 style="margin-top:16px;">Crear usuario</h3>
      <form id="formUsuario" style="display:flex;gap:8px;flex-wrap:wrap;">
        <input class="search-input" name="username" placeholder="Usuario" required style="min-width:140px;max-width:180px;">
        <input class="search-input" type="password" name="password" placeholder="Contrase√±a" required style="min-width:140px;max-width:180px;">
        <select name="rol" class="search-select" required>
          <option value="">Rol</option>
          <option value="usuario">Usuario</option>
          <option value="admin">Administrador</option>
        </select>
        <button class="btn" type="submit" style="background:var(--blue);color:white;">‚ûï Crear</button>
      </form>
    </section>

    <!-- LOGS -->
    <section class="panel tab" id="logs" hidden>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;">Logs del sistema</h2>
        <button class="btn btn-danger" id="btnLimpiarLogs">üóëÔ∏è Eliminar todos los logs</button>
      </div>
      <div class="search-bar">
        <input class="search-input" id="searchLogs" placeholder="üîç Buscar por usuario o acci√≥n..." oninput="buscarLogs()">
        <span class="search-count" id="countLogs">0 resultados</span>
        <button class="btn-clear-search" onclick="limpiarFiltrosLogs()">‚úï Limpiar</button>
      </div>
      <div class="table-wrapper" style="max-height:500px;">
        <table>
          <thead><tr><th>Fecha</th><th>Usuario</th><th>Acci√≥n</th></tr></thead>
          <tbody id="tbodyLogs">
            <tr><td colspan="3" style="text-align:center;padding:18px;color:var(--muted);">‚è≥ Cargando...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="pagination-bar">
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="pagination-info" id="infoLogs"></span>
          <select class="page-size-select" id="pageSizeLog" onchange="cambiarPagLog()">
            <option value="25">25 por p√°gina</option><option value="50">50 por p√°gina</option><option value="100">100 por p√°gina</option>
          </select>
        </div>
        <div class="pagination-btns" id="botonesLogs"></div>
      </div>
    </section>

    <!-- FORMULARIO ‚Äî estado convocatoria -->
    <section class="panel tab" id="formulario" hidden>
      <h2 style="margin-bottom:4px;">üìã Estado del Formulario P√∫blico</h2>
      <p style="color:var(--muted);font-size:13px;margin-bottom:24px;">Controla si los ciudadanos pueden registrarse. Cuando cierras la convocatoria, el formulario muestra una pantalla de "Finalizado".</p>

      <div style="max-width:520px;margin:0 auto;">
        <div id="convCard" style="border-radius:16px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,0.15);transition:all 0.4s;">
          <div style="background:linear-gradient(135deg,#003f8f 0%,#0052b8 100%);padding:28px 24px;display:flex;align-items:center;gap:18px;">
            <img src="/static/img/mml.png" alt="MML" style="height:60px;filter:drop-shadow(0 2px 8px rgba(0,0,0,0.3));">
            <div style="color:white;">
              <div style="font-size:11px;opacity:0.8;letter-spacing:1px;text-transform:uppercase;">Municipalidad Metropolitana de Lima</div>
              <div style="font-size:17px;font-weight:800;margin-top:4px;line-height:1.3;">Registro de Postulantes<br>CAS 2026 ¬∑ OGA-OGRH</div>
            </div>
          </div>
          <div style="padding:28px 24px;background:white;border:1px solid #e5e7eb;border-top:none;border-radius:0 0 16px 16px;">
            <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:28px;">
              <div id="convDot" style="width:14px;height:14px;border-radius:50%;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,0.2);transition:all 0.4s;"></div>
              <span id="convEstadoLabel" style="font-size:22px;font-weight:800;transition:all 0.3s;color:#15803d;">CONVOCATORIA ABIERTA</span>
            </div>
            <p id="convDesc" style="text-align:center;font-size:13px;color:#6b7280;margin-bottom:28px;">
              El formulario p√∫blico est√° activo. Los ciudadanos pueden registrar su postulaci√≥n.
            </p>
            <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
              <button id="btnCerrarConv" onclick="cambiarEstadoConvocatoria(false)"
                style="padding:12px 32px;border-radius:10px;border:none;cursor:pointer;font-size:14px;font-weight:700;background:#b00020;color:white;transition:all 0.2s;box-shadow:0 4px 12px rgba(176,0,32,0.3);">
                üîí Cerrar convocatoria
              </button>
              <button id="btnAbrirConv" onclick="cambiarEstadoConvocatoria(true)"
                style="padding:12px 32px;border-radius:10px;border:none;cursor:pointer;font-size:14px;font-weight:700;background:#0f9d58;color:white;transition:all 0.2s;box-shadow:0 4px 12px rgba(15,157,88,0.3);display:none;">
                üîì Abrir convocatoria
              </button>
            </div>
            <div style="text-align:center;margin-top:20px;font-size:11px;color:#9ca3af;">
              √öltimo cambio: <span id="convUltimoUpdate">‚Äî</span>
            </div>
          </div>
        </div>
        <div style="margin-top:20px;padding:16px;background:#fff8e1;border:1px solid #f59e0b;border-radius:10px;font-size:13px;color:#92400e;">
          <strong>‚ö†Ô∏è Ten en cuenta:</strong> Al cerrar la convocatoria, cualquier ciudadano que intente enviar el formulario recibir√° un mensaje de "La convocatoria ha finalizado". Los datos ya registrados no se eliminan.
        </div>
      </div>
    </section>

  </main>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header"><h3 class="modal-title" id="modalTitle">T√≠tulo</h3></div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer" id="modalFooter"></div>
  </div>
</div>

<script>
// ==========================================
// √ÅREAS
// ==========================================
const AREAS_ADMIN = {
  'GGRD':  'Gesti√≥n del Riesgo de Desastres',
  'GSCGA': 'Servicios a la Ciudad y Gesti√≥n Ambiental',
  'GFC':   'Fiscalizaci√≥n y Control',
  'GSC':   'Seguridad Ciudadana',
  'GDE':   'Desarrollo Econ√≥mico'
};

(function poblarFiltrosArea() {
  ['filtroAreaReg', 'filtroAreaRec'].forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    Object.entries(AREAS_ADMIN).forEach(([codigo]) => {
      const opt = document.createElement('option');
      opt.value = codigo;
      opt.textContent = codigo;
      sel.appendChild(opt);
    });
  });
})();

// ‚îÄ‚îÄ CSRF helper
function getCsrfToken() {
  return document.querySelector('meta[name="csrf-token"]')?.content || '';
}
function csrfHeaders() {
  return { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() };
}

// ==========================================
// UTILIDADES GLOBALES
// ==========================================
function updateDateTime(){ document.getElementById('datetime').textContent = new Date().toLocaleString('es-PE'); }
updateDateTime(); setInterval(updateDateTime, 1000);

function esc(str){
  if(str===null||str===undefined) return '-';
  const d=document.createElement('div'); d.textContent=String(str); return d.innerHTML;
}

function setOnline(){ document.getElementById('statusDot').classList.remove('offline'); document.getElementById('statusText').textContent='En l√≠nea'; }
function setOffline(){ document.getElementById('statusDot').classList.add('offline'); document.getElementById('statusText').textContent='Sin conexi√≥n'; }

function showNotif(msg, type='success'){
  const colors={success:'var(--success)',warning:'#d97706',error:'var(--danger)',info:'var(--blue-2)'};
  const n=document.createElement('div');
  n.style.cssText=`position:fixed;top:80px;right:20px;background:${colors[type]||colors.success};color:white;padding:14px 20px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.2);font-weight:700;font-size:13px;z-index:9999;transition:opacity 0.3s;`;
  n.textContent=msg; document.body.appendChild(n);
  setTimeout(()=>{n.style.opacity='0';setTimeout(()=>n.remove(),300);},3500);
}

function renderPag(containerId, pagActual, totalPag, onChange){
  const c=document.getElementById(containerId); c.innerHTML='';
  if(totalPag<=1) return;
  const mk=(txt,pg,dis=false)=>{
    const b=document.createElement('button');
    b.className='page-btn'+(pg===pagActual?' active':'');
    b.textContent=txt; b.disabled=dis; b.onclick=()=>onChange(pg); return b;
  };
  c.appendChild(mk('¬´',1,pagActual===1)); c.appendChild(mk('‚Äπ',pagActual-1,pagActual===1));
  let s=Math.max(1,pagActual-2),e=Math.min(totalPag,s+4);
  if(e-s<4) s=Math.max(1,e-4);
  for(let i=s;i<=e;i++) c.appendChild(mk(i,i));
  c.appendChild(mk('‚Ä∫',pagActual+1,pagActual===totalPag)); c.appendChild(mk('¬ª',totalPag,pagActual===totalPag));
}
</script>

<script>
// TABS Y SUB-TABS
document.querySelectorAll('.side-btn').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.side-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('.tab').forEach(t=>t.hidden=(t.id!==b.dataset.tab));
    if(b.dataset.tab==='postulantes'){ pollRegNuevos(); pollRegAtendidos(); pollRecNuevos(); }
    if(b.dataset.tab==='stats') cargarEstadisticas();
    if(b.dataset.tab==='usuarios') cargarUsuariosActivos();
    if(b.dataset.tab==='formulario') cargarEstadoConvocatoria();
    if(b.dataset.tab==='logs') cargarLogs();
  });
});
document.querySelectorAll('.sub-tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.sub-tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.sub-tab-content').forEach(c=>{c.hidden=(c.id!==btn.dataset.subtab);});
  });
});
['tableWrapperRegistrados','tableWrapperRecibidos'].forEach(id=>{
  const w=document.getElementById(id); if(!w) return;
  w.addEventListener('wheel',(e)=>{ if(w.scrollWidth>w.clientWidth&&Math.abs(e.deltaX)<=Math.abs(e.deltaY)){e.preventDefault();w.scrollLeft+=e.deltaY;} },{passive:false});
});
document.addEventListener('visibilitychange', ()=>{
  if(!document.hidden){ pollRegNuevos(); pollRegAtendidos(); pollRecNuevos(); cargarEstadisticas(); }
});
</script>

<script>
// MODAL
const modalOverlay=document.getElementById('modalOverlay');
const modalTitle=document.getElementById('modalTitle');
const modalBody=document.getElementById('modalBody');
const modalFooter=document.getElementById('modalFooter');
function showModal(cfg){
  return new Promise(resolve=>{
    modalTitle.textContent=cfg.title||'Aviso';
    const icons={success:'‚úì',error:'‚úï',warning:'‚ö†',info:'‚Ñπ'};
    let html=cfg.icon?`<div class="modal-icon ${cfg.type||'info'}">${icons[cfg.type]||'‚Ñπ'}</div>`:'';
    html+=`<div style="text-align:center">${cfg.message||''}</div>`;
    modalBody.innerHTML=html; modalFooter.innerHTML='';
    if(cfg.type==='confirm'){
      const bc=document.createElement('button'); bc.className='modal-btn modal-btn-cancel'; bc.textContent=cfg.cancelText||'Cancelar'; bc.onclick=()=>{closeModal();resolve(false);};
      const bo=document.createElement('button'); bo.className=`modal-btn modal-btn-${cfg.confirmClass||'confirm'}`; bo.textContent=cfg.confirmText||'Aceptar'; bo.onclick=()=>{closeModal();resolve(true);};
      modalFooter.appendChild(bc); modalFooter.appendChild(bo);
    } else {
      const bo=document.createElement('button'); bo.className='modal-btn modal-btn-confirm'; bo.textContent='Aceptar'; bo.onclick=()=>{closeModal();resolve(true);};
      modalFooter.appendChild(bo);
    }
    modalOverlay.classList.add('active');
  });
}
function closeModal(){ modalOverlay.classList.remove('active'); }
modalOverlay.addEventListener('click',e=>{if(e.target===modalOverlay) closeModal();});
</script>

<script>
// REGISTRADOS
let filasReg=[], filtReg=[], pagReg=1, tamReg=25, maxIdReg=0, idsReg=new Set();

function buildRowReg(p, idx){
  const tr=document.createElement('tr');
  tr.dataset.id=p.id; tr.dataset.area=p.area||''; tr.dataset.sexo=p.sexo||'';
  tr.innerHTML=`
    <td class="td-num-reg">${idx}</td>
    <td>${esc(p.area)}</td><td>${esc(p.convocatoria)}</td>
    <td class="apellidos">${esc(p.apellidos)}</td><td class="nombres">${esc(p.nombres)}</td>
    <td>${esc(p.tipo_documento)}</td><td class="num-doc">${esc(p.numero_documento)}</td>
    <td>${esc(p.fecha_nacimiento)}</td><td>${esc(p.sexo)}</td>
    <td>${esc(p.celular)}</td><td>${esc(p.correo)}</td>
    <td>${esc(p.fuerzas_armadas)}</td><td>${esc(p.tiene_discapacidad)}</td>
    <td>${esc(p.tipo_discapacidad)}</td><td>${esc(p.created_at)}</td>
    <td><button class="btn-delete js-del-registrado" data-id="${p.id}">‚úï</button></td>`;
  return tr;
}

async function cargarRegistradosInicial(){
  try{
    const res=await fetch('/api/postulantes/registrados');
    const data=await res.json();
    if(!data.ok) return;
    const tbody=document.getElementById('tbodyRegistrados');
    tbody.innerHTML=''; filasReg=[]; idsReg=new Set();
    if(!data.items.length){
      tbody.innerHTML='<tr><td colspan="16" style="text-align:center;padding:20px;color:var(--muted);">No hay postulantes pendientes</td></tr>';
      document.getElementById('badgeRegistrados').textContent=0;
      filtReg=[]; actualizarPagReg(); return;
    }
    data.items.forEach((p,i)=>{
      const tr=buildRowReg(p,i+1);
      tbody.appendChild(tr); filasReg.push(tr); idsReg.add(String(p.id));
      if(p.id>maxIdReg) maxIdReg=p.id;
    });
    filtReg=[...filasReg];
    document.getElementById('badgeRegistrados').textContent=filasReg.length;
    actualizarPagReg(); setOnline();
  }catch(e){console.error('Error carga registrados:',e); setOffline();}
}

async function pollRegNuevos(){
  if(document.hidden) return;
  try{
    const res=await fetch(`/api/postulantes/pendientes-nuevos?after_id=${maxIdReg}`);
    const data=await res.json();
    if(data.ok&&data.items?.length){
      const tbody=document.getElementById('tbodyRegistrados');
      const empty=tbody.querySelector('td[colspan]'); if(empty) tbody.innerHTML='';
      let hay=false;
      data.items.forEach(p=>{
        if(!idsReg.has(String(p.id))){
          const tr=buildRowReg(p,0);
          tbody.insertBefore(tr,tbody.firstChild);
          filasReg.unshift(tr); idsReg.add(String(p.id)); hay=true;
        }
        if(p.id>maxIdReg) maxIdReg=p.id;
      });
      if(hay){ filtrarRegistrados(false); document.getElementById('badgeRegistrados').textContent=filasReg.length; showNotif(`üìù ${data.items.length} nuevo(s) registrado(s)`,'info'); }
    }
    setOnline();
  }catch(e){console.error('Error poll reg nuevos:',e); setOffline();}
}

async function pollRegAtendidos(){
  if(document.hidden||idsReg.size===0) return;
  try{
    const idsEnPantalla=[...idsReg].map(Number);
    const res=await fetch('/api/postulantes/datos-atendidos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ids:idsEnPantalla})});
    const data=await res.json();
    if(!data.ok||!data.items?.length) return;
    data.items.forEach(p=>{
      const sid=String(p.id); if(!idsReg.has(sid)) return;
      const rowReg=document.querySelector(`#tbodyRegistrados tr[data-id="${sid}"]`);
      if(rowReg){
        idsReg.delete(sid); filasReg=filasReg.filter(r=>r.dataset.id!==sid); rowReg.remove();
        filtrarRegistrados(false); document.getElementById('badgeRegistrados').textContent=filasReg.length;
        if(filasReg.length===0) document.getElementById('tbodyRegistrados').innerHTML='<tr><td colspan="16" style="text-align:center;padding:20px;color:var(--muted);">No hay postulantes pendientes</td></tr>';
      }
      if(!document.querySelector(`#tbodyRecibidos tr[data-id="${sid}"]`)){
        const tbodyRec=document.getElementById('tbodyRecibidos');
        const empty=tbodyRec.querySelector('td[colspan]'); if(empty) tbodyRec.innerHTML='';
        const tr=buildRowRec(p); tr.classList.add('highlight-new');
        tbodyRec.insertBefore(tr,tbodyRec.firstChild); filasRec.unshift(tr);
        if(p.id>maxIdRec) maxIdRec=p.id;
        filtrarRecibidos(false); document.getElementById('badgeRecibidos').textContent=filasRec.length;
        showNotif(`‚úÖ ${p.apellidos} atendido por ${p.usuario_atendio}`,'success');
      }
    });
  }catch(e){console.error('Error poll reg atendidos:',e);}
}

function filtrarRegistrados(reset=true){
  const txt=document.getElementById('searchRegistrados').value.toLowerCase();
  const sx=document.getElementById('filtroSexoReg').value;
  const ar=document.getElementById('filtroAreaReg').value;
  filtReg=filasReg.filter(r=>{
    const ap=r.querySelector('.apellidos')?.textContent.toLowerCase()||'';
    const nb=r.querySelector('.nombres')?.textContent.toLowerCase()||'';
    const dc=r.querySelector('.num-doc')?.textContent.toLowerCase()||'';
    return(!txt||ap.includes(txt)||nb.includes(txt)||dc.includes(txt))&&(!sx||r.dataset.sexo===sx)&&(!ar||r.dataset.area===ar);
  });
  if(reset) pagReg=1; actualizarPagReg();
}
function limpiarFiltrosRegistrados(){ document.getElementById('searchRegistrados').value=''; document.getElementById('filtroSexoReg').value=''; document.getElementById('filtroAreaReg').value=''; filtrarRegistrados(); }
function actualizarPagReg(){
  const total=filtReg.length, totalPag=Math.ceil(total/tamReg)||1;
  if(pagReg>totalPag) pagReg=totalPag;
  const ini=(pagReg-1)*tamReg, fin=Math.min(ini+tamReg,total);
  filasReg.forEach(r=>r.style.display='none');
  filtReg.slice(ini,fin).forEach((r,i)=>{r.style.display=''; const c=r.querySelector('.td-num-reg'); if(c) c.textContent=ini+i+1;});
  document.getElementById('countRegistrados').textContent=`${total} resultado${total!==1?'s':''}`;
  document.getElementById('infoRegistrados').textContent=total>0?`Mostrando ${ini+1}‚Äì${fin} de ${total}`:'Sin resultados';
  renderPag('botonesRegistrados',pagReg,totalPag,pg=>{pagReg=pg;actualizarPagReg();});
}
function cambiarPagReg(){ tamReg=parseInt(document.getElementById('pageSizeReg').value); pagReg=1; actualizarPagReg(); }

cargarRegistradosInicial();
setInterval(pollRegNuevos, 3000);
setTimeout(()=>setInterval(pollRegAtendidos, 3000), 1500);
</script>

<script>
// RECIBIDOS
let filasRec=[], filtRec=[], pagRec=1, tamRec=25, maxIdRec=0;

function buildRowRec(p){
  const tr=document.createElement('tr');
  tr.dataset.id=p.id; tr.dataset.area=p.area||''; tr.dataset.sexo=p.sexo||'';
  tr.innerHTML=`
    <td class="td-num"></td>
    <td>${esc(p.area)}</td><td>${esc(p.convocatoria)}</td>
    <td class="apellidos">${esc(p.apellidos)}</td><td class="nombres">${esc(p.nombres)}</td>
    <td>${esc(p.tipo_documento)}</td><td class="num-doc">${esc(p.numero_documento)}</td>
    <td>${esc(p.fecha_nacimiento)}</td><td>${esc(p.sexo)}</td>
    <td>${esc(p.celular)}</td><td>${esc(p.correo)}</td>
    <td>${esc(p.fuerzas_armadas)}</td><td>${esc(p.tiene_discapacidad)}</td>
    <td>${esc(p.tipo_discapacidad)}</td><td>${esc(p.created_at)}</td>
    <td>${esc(p.usuario_atendio)}</td><td>${esc(p.fecha_atencion)}</td>
    <td><button class="btn-delete js-del-recibido" data-id="${p.id}">‚úï</button></td>`;
  return tr;
}

async function cargarRecibidosInicial(){
  try{
    const res=await fetch('/api/postulantes/atendidos-nuevos?after_id=0');
    const data=await res.json();
    const tbody=document.getElementById('tbodyRecibidos');
    tbody.innerHTML=''; filasRec=[];
    if(!data.ok||!data.items.length){
      tbody.innerHTML='<tr><td colspan="18" style="text-align:center;padding:20px;color:var(--muted);">No hay postulantes recibidos a√∫n</td></tr>';
      document.getElementById('badgeRecibidos').textContent=0;
      filtRec=[]; actualizarPagRec(); return;
    }
    data.items.forEach(p=>{ const tr=buildRowRec(p); tbody.appendChild(tr); filasRec.push(tr); if(p.id>maxIdRec) maxIdRec=p.id; });
    filtRec=[...filasRec]; document.getElementById('badgeRecibidos').textContent=filasRec.length;
    actualizarPagRec(); setOnline();
  }catch(e){console.error('Error carga recibidos:',e); setOffline();}
}

async function pollRecNuevos(){
  if(document.hidden) return;
  try{
    const res=await fetch(`/api/postulantes/atendidos-nuevos?after_id=${maxIdRec}`);
    const data=await res.json();
    if(data.ok&&data.items?.length){
      const tbody=document.getElementById('tbodyRecibidos');
      const empty=tbody.querySelector('td[colspan]'); if(empty) tbody.innerHTML='';
      let hayNuevos=false;
      data.items.forEach(p=>{
        if(document.querySelector(`#tbodyRecibidos tr[data-id="${p.id}"]`)) return;
        if(p.id>maxIdRec) maxIdRec=p.id;
        const tr=buildRowRec(p); tr.classList.add('highlight-new');
        tbody.insertBefore(tr,tbody.firstChild); filasRec.unshift(tr); hayNuevos=true;
      });
      data.items.forEach(p=>{ if(p.id>maxIdRec) maxIdRec=p.id; });
      if(hayNuevos){ filtrarRecibidos(false); document.getElementById('badgeRecibidos').textContent=filasRec.length; }
    }
    setOnline();
  }catch(e){console.error('Error poll recibidos:',e); setOffline();}
}

function filtrarRecibidos(reset=true){
  const txt=document.getElementById('searchRecibidos').value.toLowerCase();
  const sx=document.getElementById('filtroSexoRec').value;
  const ar=document.getElementById('filtroAreaRec').value;
  filtRec=filasRec.filter(r=>{
    const ap=r.querySelector('.apellidos')?.textContent.toLowerCase()||'';
    const nb=r.querySelector('.nombres')?.textContent.toLowerCase()||'';
    const dc=r.querySelector('.num-doc')?.textContent.toLowerCase()||'';
    return(!txt||ap.includes(txt)||nb.includes(txt)||dc.includes(txt))&&(!sx||r.dataset.sexo===sx)&&(!ar||r.dataset.area===ar);
  });
  if(reset) pagRec=1; actualizarPagRec();
}
function limpiarFiltrosRecibidos(){ document.getElementById('searchRecibidos').value=''; document.getElementById('filtroSexoRec').value=''; document.getElementById('filtroAreaRec').value=''; filtrarRecibidos(); }
function actualizarPagRec(){
  const total=filtRec.length, totalPag=Math.ceil(total/tamRec)||1;
  if(pagRec>totalPag) pagRec=totalPag;
  const ini=(pagRec-1)*tamRec, fin=Math.min(ini+tamRec,total);
  filasRec.forEach(r=>r.style.display='none');
  filtRec.slice(ini,fin).forEach((r,i)=>{r.style.display=''; const c=r.querySelector('.td-num'); if(c) c.textContent=ini+i+1;});
  document.getElementById('countRecibidos').textContent=`${total} resultado${total!==1?'s':''}`;
  document.getElementById('infoRecibidos').textContent=total>0?`Mostrando ${ini+1}‚Äì${fin} de ${total}`:'Sin resultados';
  renderPag('botonesRecibidos',pagRec,totalPag,pg=>{pagRec=pg;actualizarPagRec();});
}
function cambiarPagRec(){ tamRec=parseInt(document.getElementById('pageSizeRec').value); pagRec=1; actualizarPagRec(); }

cargarRecibidosInicial();
setInterval(pollRecNuevos, 4000);
</script>

<script>
// ELIMINAR POSTULANTES
document.addEventListener('click', async e=>{
  if(e.target.classList.contains('js-del-registrado')){
    const id=e.target.dataset.id;
    const row=document.querySelector(`#tbodyRegistrados tr[data-id="${id}"]`); if(!row) return;
    const nombre=row.querySelector('.apellidos')?.textContent||'este postulante';
    const ok=await showModal({title:'¬øEliminar postulante?',message:`¬øEliminar a <strong>${esc(nombre)}</strong>?`,icon:true,type:'confirm',confirmText:'S√≠, eliminar',cancelText:'Cancelar',confirmClass:'danger'});
    if(!ok) return;
    const res=await fetch(`/api/eliminar/${id}`,{method:'POST',headers:csrfHeaders()});
    const data=await res.json();
    if(data.ok){
      idsReg.delete(String(id)); filasReg=filasReg.filter(r=>r.dataset.id!==id); row.remove();
      filtrarRegistrados(false); document.getElementById('badgeRegistrados').textContent=filasReg.length;
      if(filasReg.length===0) document.getElementById('tbodyRegistrados').innerHTML='<tr><td colspan="16" style="text-align:center;padding:20px;color:var(--muted);">No hay postulantes pendientes</td></tr>';
      await showModal({title:'Eliminado',message:`<strong>${esc(nombre)}</strong> eliminado.`,icon:true,type:'success'});
    } else { await showModal({title:'Error',message:data.error||'No se pudo eliminar.',icon:true,type:'error'}); }
  }
  if(e.target.classList.contains('js-del-recibido')){
    const id=e.target.dataset.id;
    const row=document.querySelector(`#tbodyRecibidos tr[data-id="${id}"]`); if(!row) return;
    const nombre=row.querySelector('.apellidos')?.textContent||'';
    const ok=await showModal({title:'¬øEliminar postulante?',message:`¬øEliminar a <strong>${esc(nombre)}</strong>?`,icon:true,type:'confirm',confirmText:'S√≠, eliminar',cancelText:'Cancelar',confirmClass:'danger'});
    if(!ok) return;
    const res=await fetch(`/api/eliminar/${id}`,{method:'POST',headers:csrfHeaders()});
    const data=await res.json();
    if(data.ok){
      filasRec=filasRec.filter(r=>r.dataset.id!==id); row.remove();
      filtrarRecibidos(false); document.getElementById('badgeRecibidos').textContent=filasRec.length;
      if(filasRec.length===0) document.getElementById('tbodyRecibidos').innerHTML='<tr><td colspan="18" style="text-align:center;padding:20px;color:var(--muted);">No hay postulantes recibidos a√∫n</td></tr>';
      await showModal({title:'Eliminado',message:`<strong>${esc(nombre)}</strong> eliminado.`,icon:true,type:'success'});
    } else { await showModal({title:'Error',message:data.error||'No se pudo eliminar.',icon:true,type:'error'}); }
  }
});
</script>

<script>
// USUARIOS
let filasUsr=[], filtUsr=[], pagUsr=1, tamUsr=10;
function initUsuarios(){ filasUsr=Array.from(document.querySelectorAll('#tbodyUsuarios tr[data-username]')); filtUsr=[...filasUsr]; actualizarPagUsr(); }
function filtrarUsuarios(){
  const txt=document.getElementById('searchUsuarios').value.toLowerCase();
  const rol=document.getElementById('filtroRolUsr').value;
  filtUsr=filasUsr.filter(r=>{ const u=r.querySelector('.td-username')?.textContent.toLowerCase()||''; return(!txt||u.includes(txt))&&(!rol||r.dataset.rol===rol); });
  pagUsr=1; actualizarPagUsr();
}
function limpiarFiltrosUsuarios(){ document.getElementById('searchUsuarios').value=''; document.getElementById('filtroRolUsr').value=''; filtrarUsuarios(); }
function actualizarPagUsr(){
  const total=filtUsr.length, totalPag=Math.ceil(total/tamUsr)||1;
  if(pagUsr>totalPag) pagUsr=totalPag;
  const ini=(pagUsr-1)*tamUsr, fin=Math.min(ini+tamUsr,total);
  filasUsr.forEach(r=>r.style.display='none'); filtUsr.slice(ini,fin).forEach(r=>r.style.display='');
  document.getElementById('countUsuarios').textContent=`${total} resultado${total!==1?'s':''}`;
  document.getElementById('infoUsuarios').textContent=total>0?`Mostrando ${ini+1}‚Äì${fin} de ${total}`:'Sin resultados';
  renderPag('botonesUsuarios',pagUsr,totalPag,pg=>{pagUsr=pg;actualizarPagUsr();});
}
function cambiarPagUsr(){ tamUsr=parseInt(document.getElementById('pageSizeUsr').value); pagUsr=1; actualizarPagUsr(); }
initUsuarios();

document.addEventListener('click', async e=>{
  if(!e.target.classList.contains('js-del-usuario')) return;
  const username=e.target.dataset.username; if(username==='admin') return;
  const row=document.querySelector(`#tbodyUsuarios tr[data-username="${username}"]`);
  const ok=await showModal({title:'¬øEliminar usuario?',message:`¬øEliminar a <strong>${esc(username)}</strong>?`,icon:true,type:'confirm',confirmText:'S√≠, eliminar',cancelText:'Cancelar',confirmClass:'danger'});
  if(!ok) return;
  const res=await fetch('/api/eliminar-usuario',{method:'POST',headers:csrfHeaders(),body:JSON.stringify({username})});
  const data=await res.json();
  if(data.ok){ filasUsr=filasUsr.filter(r=>r.dataset.username!==username); row?.remove(); filtrarUsuarios(); await showModal({title:'Eliminado',message:`Usuario <strong>${esc(username)}</strong> eliminado.`,icon:true,type:'success'}); }
  else { await showModal({title:'Error',message:data.error||'No se pudo eliminar.',icon:true,type:'error'}); }
});

document.getElementById('formUsuario').addEventListener('submit', async e=>{
  e.preventDefault();
  const f=e.target;
  const btn=f.querySelector('button[type=submit]');
  const username=f.username.value.trim(), password=f.password.value, rol=f.rol.value;
  if(!rol){ await showModal({title:'Error',message:'Selecciona un rol.',icon:true,type:'error'}); return; }
  btn.disabled=true;
  const res=await fetch('/api/crear-usuario',{method:'POST',headers:csrfHeaders(),body:JSON.stringify({username,password,rol})});
  btn.disabled=false;
  const r=await res.json();
  if(r.ok){
    await showModal({title:'Usuario creado',message:`<strong>${esc(username)}</strong> creado exitosamente.`,icon:true,type:'success'});
    const tbody=document.getElementById('tbodyUsuarios');
    const newRow=document.createElement('tr');
    newRow.dataset.username=username; newRow.dataset.rol=rol;
    newRow.innerHTML=`
      <td class="td-username"></td>
      <td class="td-rol"></td>
      <td class="td-estado"><span class="badge badge-ok">Activo</span></td>
      <td class="td-conexion">
        <div style="display:flex;align-items:center;gap:6px;">
          <div class="conexion-dot" style="background:#f87171;" title="Desconectado"></div>
          <span class="conexion-label" style="font-size:11px;color:var(--muted);">Desconectado</span>
        </div>
      </td>
      <td><button class="btn" style="background:#7c3aed;color:white;" onclick="cambiarPassword('${username}')">üîë Cambiar</button></td>
      <td class="td-acciones">
        <button class="btn btn-activar" style="background:var(--success);color:#fff;opacity:0.4" disabled>Activar</button>
        <button class="btn btn-danger btn-desactivar">Desactivar</button>
      </td>
      <td><button class="btn-delete js-del-usuario" data-username=""></button></td>`;
    newRow.querySelector('.td-username').textContent=username;
    newRow.querySelector('.td-rol').textContent=rol;
    newRow.querySelector('.btn-desactivar').onclick=()=>desactivarUsuario(username);
    newRow.querySelector('.btn-activar').onclick=()=>activarUsuario(username);
    const delBtn=newRow.querySelector('.js-del-usuario'); delBtn.dataset.username=username; delBtn.textContent='‚úï';
    tbody.appendChild(newRow); filasUsr.push(newRow); filtrarUsuarios(); f.reset();
  } else { await showModal({title:'Error',message:r.error||'No se pudo crear el usuario',icon:true,type:'error'}); }
});

async function cambiarPassword(username) {
  const nueva = prompt(`Nueva contrase√±a para "${username}":`);
  if (!nueva || !nueva.trim()) return;
  const res = await fetch('/api/cambiar-password', {
    method: 'POST',
    headers: csrfHeaders(),
    body: JSON.stringify({ username, password: nueva.trim() })
  });
  const data = await res.json();
  if (data.ok) showNotif(`‚úÖ Contrase√±a de ${username} actualizada`, 'success');
  else await showModal({ title: 'Error', message: data.error || 'No se pudo cambiar.', icon: true, type: 'error' });
}

async function desactivarUsuario(username){
  const ok=await showModal({title:'¬øDesactivar?',message:`¬øDesactivar a <strong>${esc(username)}</strong>?`,icon:true,type:'confirm',confirmText:'Desactivar',cancelText:'Cancelar',confirmClass:'danger'});
  if(!ok) return;
  const res=await fetch('/api/desactivar-usuario',{method:'POST',headers:csrfHeaders(),body:JSON.stringify({username})});
  const r=await res.json();
  if(r.ok){
    const row=document.querySelector(`tr[data-username="${username}"]`);
    if(row){ row.querySelector('.td-estado').innerHTML='<span class="badge badge-off">Inactivo</span>'; const ba=row.querySelector('.btn-activar'),bd=row.querySelector('.btn-desactivar'); if(ba){ba.disabled=false;ba.style.opacity='1';} if(bd){bd.disabled=true;bd.style.opacity='0.4';} }
    await showModal({title:'Desactivado',message:`<strong>${esc(username)}</strong> desactivado.`,icon:true,type:'success'});
  } else { await showModal({title:'Error',message:r.error||'No se pudo desactivar.',icon:true,type:'error'}); }
}
async function activarUsuario(username){
  const ok=await showModal({title:'¬øActivar?',message:`¬øActivar a <strong>${esc(username)}</strong>?`,icon:true,type:'confirm',confirmText:'Activar',cancelText:'Cancelar',confirmClass:'success'});
  if(!ok) return;
  const res=await fetch('/api/activar-usuario',{method:'POST',headers:csrfHeaders(),body:JSON.stringify({username})});
  const r=await res.json();
  if(r.ok){
    const row=document.querySelector(`tr[data-username="${username}"]`);
    if(row){ row.querySelector('.td-estado').innerHTML='<span class="badge badge-ok">Activo</span>'; const ba=row.querySelector('.btn-activar'),bd=row.querySelector('.btn-desactivar'); if(ba){ba.disabled=true;ba.style.opacity='0.4';} if(bd){bd.disabled=false;bd.style.opacity='1';} }
    await showModal({title:'Activado',message:`<strong>${esc(username)}</strong> activado.`,icon:true,type:'success'});
  } else { await showModal({title:'Error',message:r.error||'No se pudo activar.',icon:true,type:'error'}); }
}
</script>

<script>
// LOGS ‚Äî cargados via API con paginaci√≥n servidor
let pagLog=1, tamLog=25, totalLogs=0, busquedaLog='', _logTimer=null;

async function cargarLogs(reset=true){
  if(reset) pagLog=1;
  const tbody=document.getElementById('tbodyLogs');
  tbody.innerHTML='<tr><td colspan="3" style="text-align:center;padding:18px;color:var(--muted);">‚è≥ Cargando...</td></tr>';
  try{
    const params=new URLSearchParams({pagina:pagLog,tam:tamLog,buscar:busquedaLog});
    const res=await fetch('/api/logs?'+params);
    const data=await res.json();
    if(!data.ok) return;
    totalLogs=data.total;
    tbody.innerHTML='';
    if(!data.items.length){
      tbody.innerHTML='<tr><td colspan="3" style="text-align:center;padding:18px;color:var(--muted);">No hay logs</td></tr>';
    } else {
      data.items.forEach(l=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${esc(l.fecha)}</td><td>${esc(l.usuario)}</td><td>${esc(l.accion)}</td>`;
        tbody.appendChild(tr);
      });
    }
    const total=totalLogs;
    const totalPag=Math.ceil(total/tamLog)||1;
    const ini=(pagLog-1)*tamLog+1, fin=Math.min(pagLog*tamLog,total);
    document.getElementById('countLogs').textContent=`${total} resultado${total!==1?'s':''}`;
    document.getElementById('infoLogs').textContent=total>0?`Mostrando ${ini}‚Äì${fin} de ${total}`:'Sin resultados';
    renderPag('botonesLogs',pagLog,totalPag,pg=>{pagLog=pg;cargarLogs(false);});
  }catch(e){console.error('Error logs:',e);}
}

function buscarLogs(){
  clearTimeout(_logTimer);
  _logTimer=setTimeout(()=>{ busquedaLog=document.getElementById('searchLogs').value.trim(); cargarLogs(); },400);
}
function limpiarFiltrosLogs(){ document.getElementById('searchLogs').value=''; busquedaLog=''; cargarLogs(); }
function cambiarPagLog(){ tamLog=parseInt(document.getElementById('pageSizeLog').value); cargarLogs(); }

cargarLogs();

document.getElementById('btnLimpiarLogs').addEventListener('click', async()=>{
  const ok=await showModal({title:'¬øEliminar todos los logs?',message:'‚ö†Ô∏è Se eliminar√°n TODOS los logs. No se puede deshacer.',icon:true,type:'confirm',confirmText:'S√≠, eliminar todo',cancelText:'Cancelar',confirmClass:'danger'});
  if(!ok) return;
  const res=await fetch('/api/limpiar-logs',{method:'POST',headers:csrfHeaders()});
  const data=await res.json();
  if(data.ok){
    await showModal({title:'Logs eliminados',message:`Se eliminaron <strong>${data.eliminados}</strong> registro(s).`,icon:true,type:'success'});
    busquedaLog=''; document.getElementById('searchLogs').value=''; cargarLogs();
  }
});
</script>

<script>
// ESTAD√çSTICAS
const AREA_CFG={
  GGRD: {nombre:'Gesti√≥n del Riesgo de Desastres',icon:'üö®',bg:'linear-gradient(135deg,#fee2e2,#fecaca)',primary:'#dc2626',secondary:'#991b1b'},
  GSCGA:{nombre:'Servicios a la Ciudad y Gesti√≥n Ambiental',icon:'üåø',bg:'linear-gradient(135deg,#d1fae5,#a7f3d0)',primary:'#10b981',secondary:'#047857'},
  GFC:  {nombre:'Fiscalizaci√≥n y Control',icon:'üëÆ',bg:'linear-gradient(135deg,#dbeafe,#bfdbfe)',primary:'#3b82f6',secondary:'#1e40af'},
  GSC:  {nombre:'Seguridad Ciudadana',icon:'üõ°Ô∏è',bg:'linear-gradient(135deg,#ede9fe,#ddd6fe)',primary:'#8b5cf6',secondary:'#6d28d9'},
  GDE:  {nombre:'Desarrollo Econ√≥mico',icon:'üíº',bg:'linear-gradient(135deg,#fef3c7,#fde68a)',primary:'#f59e0b',secondary:'#d97706'}
};

async function cargarEstadisticas(){
  if(document.hidden) return;
  try{
    const res=await fetch('/api/estadisticas');
    const data=await res.json();
    if(!data.ok) return;
    document.getElementById('statMujeresRegistradas').textContent=data.registrados_mujeres||0;
    document.getElementById('statHombresRegistrados').textContent=data.registrados_hombres||0;
    document.getElementById('statMujeresRecibidas').textContent=data.recibidos_mujeres||0;
    document.getElementById('statHombresRecibidos').textContent=data.recibidos_hombres||0;
    if(data.por_area){
      const container=document.getElementById('statsAreas'); container.innerHTML='';
      Object.entries(data.por_area).forEach(([codigo,total])=>{
        const cfg=AREA_CFG[codigo]||{nombre:codigo,icon:'üìã',bg:'linear-gradient(135deg,#f3f4f6,#e5e7eb)',primary:'#6b7280',secondary:'#374151'};
        const card=document.createElement('div');
        card.style.cssText=`background:${cfg.bg};border-radius:16px;padding:24px;box-shadow:0 4px 12px rgba(0,0,0,0.1);`;
        card.innerHTML=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;"><div style="width:48px;height:48px;background:${cfg.primary};border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:white;">${cfg.icon}</div><div><div class="area-nombre" style="font-size:13px;font-weight:700;color:${cfg.secondary};"></div><div style="font-size:11px;color:${cfg.primary};">Total postulantes</div></div></div><div style="font-size:36px;font-weight:800;color:${cfg.primary};">${Number(total)}</div>`;
        card.querySelector('.area-nombre').textContent=cfg.nombre;
        container.appendChild(card);
      });
    }
  }catch(e){console.error('Error estad√≠sticas:',e);}
}
cargarEstadisticas();
setInterval(cargarEstadisticas, 5000);
</script>

<script>
// CONVOCATORIA
let convActiva = true;

async function cargarEstadoConvocatoria() {
  try {
    const res = await fetch('/api/convocatoria/estado');
    const data = await res.json();
    if (data.ok) aplicarEstadoConvocatoria(data.activa);
  } catch(e) { console.error('Error cargando estado convocatoria:', e); }
}

function aplicarEstadoConvocatoria(activa) {
  convActiva = activa;
  const dot    = document.getElementById('convDot');
  const label  = document.getElementById('convEstadoLabel');
  const desc   = document.getElementById('convDesc');
  const card   = document.getElementById('convCard');
  const btnCerrar = document.getElementById('btnCerrarConv');
  const btnAbrir  = document.getElementById('btnAbrirConv');

  if (activa) {
    dot.style.background = '#22c55e';
    dot.style.boxShadow  = '0 0 0 4px rgba(34,197,94,0.2)';
    label.textContent    = 'CONVOCATORIA ABIERTA';
    label.style.color    = '#15803d';
    desc.textContent     = 'El formulario p√∫blico est√° activo. Los ciudadanos pueden registrar su postulaci√≥n.';
    card.style.boxShadow = '0 12px 40px rgba(0,0,0,0.15)';
    btnCerrar.style.display = '';
    btnAbrir.style.display  = 'none';
  } else {
    dot.style.background = '#b00020';
    dot.style.boxShadow  = '0 0 0 4px rgba(176,0,32,0.2)';
    label.textContent    = 'CONVOCATORIA CERRADA';
    label.style.color    = '#b00020';
    desc.textContent     = 'El formulario p√∫blico est√° desactivado. Ning√∫n ciudadano puede registrarse en este momento.';
    card.style.boxShadow = '0 12px 40px rgba(176,0,32,0.2)';
    btnCerrar.style.display = 'none';
    btnAbrir.style.display  = '';
  }
  const ahora = new Date().toLocaleString('es-PE');
  document.getElementById('convUltimoUpdate').textContent = ahora;
}

async function cambiarEstadoConvocatoria(nuevoEstado) {
  const msg = nuevoEstado
    ? '¬øDeseas <strong>ABRIR</strong> la convocatoria?<br><br>Los ciudadanos podr√°n registrarse nuevamente.'
    : '¬øDeseas <strong>CERRAR</strong> la convocatoria?<br><br>Ning√∫n ciudadano podr√° registrarse hasta que la vuelvas a abrir.';

  const ok = await showModal({
    title: nuevoEstado ? 'üîì Abrir convocatoria' : 'üîí Cerrar convocatoria',
    message: msg, icon: true, type: 'confirm',
    confirmText: nuevoEstado ? 'S√≠, abrir' : 'S√≠, cerrar',
    cancelText: 'Cancelar',
    confirmClass: nuevoEstado ? 'success' : 'danger'
  });
  if (!ok) return;

  try {
    const res = await fetch('/api/convocatoria/estado', {
      method: 'POST', headers: csrfHeaders(),
      body: JSON.stringify({ activa: nuevoEstado })
    });
    const data = await res.json();
    if (data.ok) {
      aplicarEstadoConvocatoria(data.activa);
      showNotif(
        nuevoEstado ? '‚úÖ Convocatoria abierta ‚Äî el formulario est√° activo' : 'üîí Convocatoria cerrada ‚Äî el formulario est√° desactivado',
        nuevoEstado ? 'success' : 'warning'
      );
    } else {
      await showModal({ title: 'Error', message: data.error || 'No se pudo cambiar el estado.', icon: true, type: 'error' });
    }
  } catch(e) {
    await showModal({ title: 'Error', message: 'Error de conexi√≥n.', icon: true, type: 'error' });
  }
}
</script>

<script>
// ==========================================
// USUARIOS CONECTADOS ‚Äî heartbeat + polling
// Actualiza indicadores en tabla Y sidebar
// ==========================================

async function sendHeartbeat() {
  try {
    await fetch('/api/heartbeat', { method: 'POST', headers: csrfHeaders() });
  } catch(e) { /* silencioso */ }
}

// Actualiza los puntos verde/rojo en la tabla de usuarios
function actualizarDotsTabla(activos) {
  const activosSet = new Set(activos.map(u => u.username));
  document.querySelectorAll('#tbodyUsuarios tr[data-username]').forEach(row => {
    const username = row.dataset.username;
    const dot = row.querySelector('.conexion-dot');
    const label = row.querySelector('.conexion-label');
    if (!dot) return;
    const conectado = activosSet.has(username);
    dot.style.background = conectado ? '#22c55e' : '#f87171';
    dot.title = conectado ? 'Conectado' : 'Desconectado';
    if (label) {
      label.textContent = conectado ? 'Conectado' : 'Desconectado';
      label.style.color = conectado ? '#15803d' : 'var(--muted)';
    }
  });
}

// Actualiza el mini-panel de la sidebar
function actualizarSidebar(activos) {
  const lista  = document.getElementById('sidebarListaActivos');
  const badge  = document.getElementById('sidebarBadgeActivos');
  if (!lista || !badge) return;

  badge.textContent = activos.length;

  if (activos.length === 0) {
    lista.innerHTML = '<span style="font-size:11px;color:var(--muted);font-style:italic;">Nadie conectado</span>';
    return;
  }

  lista.innerHTML = activos.map(u => {
    const esAdmin = u.rol === 'admin';
    const color = esAdmin ? '#f59e0b' : '#3b82f6';
    return `<div style="display:flex;align-items:center;gap:6px;padding:5px 8px;background:#f8fafc;border-radius:8px;border:1px solid var(--border);">
      <div style="width:8px;height:8px;border-radius:50%;background:#22c55e;flex-shrink:0;"></div>
      <span style="font-size:11px;font-weight:700;color:var(--text);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(u.username)}</span>
      <span style="background:${color};color:white;padding:1px 5px;border-radius:4px;font-size:9px;font-weight:700;">${u.rol}</span>
    </div>`;
  }).join('');
}

async function cargarUsuariosActivos() {
  try {
    const res = await fetch('/api/usuarios-activos');
    const data = await res.json();
    if (!data.ok) return;

    const activos = data.activos || [];

    // Actualizar panel principal (pesta√±a Usuarios)
    const lista  = document.getElementById('listaActivos');
    const badge  = document.getElementById('badgeActivos');
    badge.textContent = activos.length;

    if (activos.length === 0) {
      lista.innerHTML = '<span style="font-size:12px;color:#6b7280;font-style:italic;">Ning√∫n usuario activo en este momento</span>';
    } else {
      lista.innerHTML = activos.map(u => {
        const rolColor = u.rol === 'admin'
          ? { bg: '#fef3c7', border: '#f59e0b', text: '#92400e', badge: '#f59e0b' }
          : { bg: '#e0f2fe', border: '#38bdf8', text: '#0369a1', badge: '#0284c7' };
        const segs = u.segundos_inactivo;
        const tiempoStr = segs < 10 ? 'activo ahora' : `hace ${segs}s`;
        return `<div style="display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:99px;background:${rolColor.bg};border:1px solid ${rolColor.border};font-size:12px;font-weight:700;color:${rolColor.text};">
          <div style="width:8px;height:8px;border-radius:50%;background:#22c55e;animation:pulse 2s infinite;"></div>
          ${esc(u.username)}
          <span style="background:${rolColor.badge};color:white;padding:1px 7px;border-radius:99px;font-size:10px;font-weight:700;">${u.rol}</span>
          <span style="font-size:10px;font-weight:400;opacity:0.7;">${tiempoStr}</span>
        </div>`;
      }).join('');
    }

    // Actualizar dots en tabla y mini-panel sidebar
    actualizarDotsTabla(activos);
    actualizarSidebar(activos);

  } catch(e) { console.error('Error cargando usuarios activos:', e); }
}

// Heartbeat cada 30s, polling cada 10s
sendHeartbeat();
setInterval(sendHeartbeat, 30000);
setInterval(cargarUsuariosActivos, 10000);

// Cargar inmediatamente
cargarUsuariosActivos();
</script>

</body>
</html>